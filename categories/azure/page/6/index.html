<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure &middot; re-imagine</title>

    <meta name="description" content="my life is the sum of my imagination">

    <meta name="generator" content="Hugo 0.17" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="tmak_tw" />
    <meta name="twitter:title" content="Azure &middot; re-imagine">
    <meta name="twitter:description" content="my life is the sum of my imagination">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Azure &middot; re-imagine">
    <meta property="og:description" content="my life is the sum of my imagination">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="http://torumakabe.github.io//css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="re-imagine" href="http://torumakabe.github.io//index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="http://torumakabe.github.io/">re-imagine</a></h1>
            <h2 class="brand-tagline"> my life is the sum of my imagination </h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/tmak_tw"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/ToruMakabe "><i class="fa fa-github-alt"></i> github</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="http://torumakabe.github.io//index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">23 Mar 2016, 13:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/azure_terraform_429_workaround/" class="post-title">Azure &amp; Terraform エラーコード429の対処法</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="terraformer増加に備えて">Terraformer増加に備えて</h2>

<p>2016/3/21にリリースされたTerraform v0.6.14で、Azure Resource Manager ProviderのリソースにVMとテンプレートデプロイが<a href="https://github.com/hashicorp/terraform/blob/v0.6.14/CHANGELOG.md">追加</a>されました。待っていた人も多いのではないでしょうか。</p>

<p>追って<a href="https://www.hashicorp.com/partners.html#sipart">Hashicorp認定パートナー</a>のクリエーションラインさんから導入・サポートサービスが<a href="http://www.creationline.com/lab/13268">アナウンス</a>されましたし、今後AzureをTerraformでコントロールしようという需要は増えそうです。</p>

<h2 id="エラーコード429">エラーコード429</h2>

<p>さて、TerraformでAzureをいじっていると、下記のようなエラーに出くわすことがあります。</p>

<pre><code>Error applying plan:

1 error(s) occurred:
azurerm_virtual_network.vnet1: autorest:DoErrorUnlessStatusCode 429 PUT https://management.azure.com/subscriptions/my_subscription_id/resourceGroups/mygroup/providers/Microsoft.Network/virtualnetworks/vnet1?api-version=2015-06-15 failed with 429
</code></pre>

<p>autorestがステータスコード429をキャッチしました。<a href="https://tools.ietf.org/html/rfc6585#section-4">RFC上で429は</a>&ldquo;Too many requests&rdquo;です。何かが多すぎたようです。</p>

<h2 id="対処法">対処法</h2>

<p><strong>もう一度applyしてください</strong></p>

<p>冪等性最高。冪等性なんていらない、という人もいますが、こういうときはありがたい。Terraformが作成に失敗したリソースのみ再作成します。</p>

<h2 id="背景">背景</h2>

<p>エラーになった背景ですが、2つの可能性があります。</p>

<ol>
<li>APIリクエスト数上限に達した</li>
<li>リソースの作成や更新に時間がかかっており、Azure側で処理を中断した</li>
</ol>

<h3 id="1-apiリクエスト数上限に達した">1. APIリクエスト数上限に達した</h3>

<p>Azure Resource Manager APIには時間当たりのリクエスト数制限があります。読み取り 15,000/時、書き込み1,200/時です。</p>

<p><strong><a href="https://azure.microsoft.com/ja-jp/documentation/articles/azure-subscription-service-limits/">Azure サブスクリプションとサービスの制限、クォータ、制約</a></strong></p>

<p>Terraformは扱うリソースごとにAPIをコールするので、数が多い環境で作って壊してをやると、この上限にひっかかる可能性があります。</p>

<p>長期的な対処として、Terraformにリトライ/Exponential Backoffロジックなどを実装してもらうのがいいのか、このままユーザ側でシンプルにリトライすべきか、悩ましいところです。</p>

<p>ひとまずプロダクトの方針は確認したいので、Issueに質問を<a href="https://github.com/hashicorp/terraform/issues/5704">あげておきました</a>。</p>

<h3 id="2-リソースの作成や更新に時間がかかっており-azure側で処理を中断した">2. リソースの作成や更新に時間がかかっており、Azure側で処理を中断した</h3>

<p>Terraform側ではエラーコードで判断するしかありませんが、Azureの監査ログで詳細が確認できます。</p>

<p>わたしが経験したエラーの中に、こんなものがありました。</p>

<pre><code>Cannot proceed with operation since resource /subscriptions/GUID/resourceGroups/xxxx/providers/Microsoft.Network/networkSecurityGroups/yyy allocated to resource /subscriptions/GUID/resourceGroups/***/providers/Microsoft.Network/virtualNetworks/yyy is not in Succeeded state. Resource is in Updating state and the last operation that updated/is updating the resource is PutSecurityRuleOperation. 
</code></pre>

<p>Too many requestsというよりは、リソースのアップデートが終わってないので先に進めない、という内容です。</p>

<p>Too many requestsをどう解釈するかにもよりますが、ちょっと混乱しますね。この問題はFeedbackとして<a href="https://feedback.azure.com/forums/34192--general-feedback/suggestions/13069563-better-http-status-code-instead-of-429">あがっています</a>。</p>

<p>でも安心してください。<strong>もう一度applyしてください</strong>。</p>

<p><strong>(2016/3/25 追記) 回避策を<a href="http://torumakabe.github.io/post/azure_terraform_earlyphase_tips/">別エントリ</a>に書きました</strong></p>

                    </div>
                </section>
                
                <h1 class="content-subhead">17 Mar 2016, 23:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/azure_packer_ansible_arm_sp/" class="post-title">PackerとAnsibleでAzureのGolden Imageを作る(ARM対応)</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="いつの間に">いつの間に</h2>

<p>ナイスな感じにイメージを作ってくれるPackerですが、いつの間にか<a href="https://www.packer.io/docs/builders/azure.html">Azure ARM対応のBuilder</a>が出ておりました。0.10からかな。早く言ってください。</p>

<h2 id="ansible-localと組み合わせたサンプル">ansible_localと組み合わせたサンプル</h2>

<p>さっそく試してそつなく動くことを確認しました。サンプルを<a href="https://github.com/ToruMakabe/Packer_Azure_Sample">Githubにあげておきます</a>。</p>

<p>手の込んだ設定もできるように、Provisonerにansible_localを使うサンプルで。</p>

<h3 id="前準備">前準備</h3>

<ul>
<li>リソースグループとストレージアカウントを作っておいてください。そこにイメージが格納されます。</li>
<li>認証情報の類は外だしします。builder/variables.sample.jsonを参考にしてください。</li>
<li>Packerの構成ファイルはOSに合わせて書きます。サンプルのbuilder/ubuntu.jsonはubuntuの例です。

<ul>
<li>Azure ARM BuilderはまだWindowsに対応していません。開発中とのこと。</li>
</ul></li>
<li>ansibleはapache2をインストール、サービスEnableするサンプルにしました。</li>
</ul>

<h3 id="サンプル">サンプル</h3>

<p>ubuntu.jsonはこんな感じです。</p>

<pre><code>{
  &quot;variables&quot;: {
    &quot;client_id&quot;: &quot;&quot;,
    &quot;client_secret&quot;: &quot;&quot;,
    &quot;resource_group&quot;: &quot;&quot;,
    &quot;storage_account&quot;: &quot;&quot;,
    &quot;subscription_id&quot;: &quot;&quot;,
    &quot;tenant_id&quot;: &quot;&quot;
  },
  &quot;builders&quot;: [{
    &quot;type&quot;: &quot;azure-arm&quot;,

    &quot;client_id&quot;: &quot;{{user `client_id`}}&quot;,
    &quot;client_secret&quot;: &quot;{{user `client_secret`}}&quot;,
    &quot;resource_group_name&quot;: &quot;{{user `resource_group`}}&quot;,
    &quot;storage_account&quot;: &quot;{{user `storage_account`}}&quot;,
    &quot;subscription_id&quot;: &quot;{{user `subscription_id`}}&quot;,
    &quot;tenant_id&quot;: &quot;{{user `tenant_id`}}&quot;,

    &quot;capture_container_name&quot;: &quot;images&quot;,
    &quot;capture_name_prefix&quot;: &quot;packer&quot;,

    &quot;image_publisher&quot;: &quot;Canonical&quot;,
    &quot;image_offer&quot;: &quot;UbuntuServer&quot;,
    &quot;image_sku&quot;: &quot;14.04.3-LTS&quot;,

    &quot;location&quot;: &quot;Japan West&quot;,
    &quot;vm_size&quot;: &quot;Standard_D1&quot;
  }],
  &quot;provisioners&quot;: [{
    &quot;type&quot;: &quot;shell&quot;,
      &quot;scripts&quot;: [
        &quot;../script/ubuntu/provision.sh&quot;
    ]
  },
  {
    &quot;type&quot;: &quot;ansible-local&quot;,
    &quot;playbook_file&quot;: &quot;../ansible/baseimage.yml&quot;,
    &quot;inventory_file&quot;: &quot;../ansible/hosts&quot;,
    &quot;role_paths&quot;: [
      &quot;../ansible/roles/baseimage&quot;
    ]
  },
  {
    &quot;type&quot;: &quot;shell&quot;,
      &quot;scripts&quot;: [
        &quot;../script/ubuntu/deprovision.sh&quot;
    ]
  }]
}
</code></pre>

<p>waagentによるde-provisionはansibleでもできるのですが、他OS対応も考えて、最後に追いshellしてます。他ファイルは<a href="https://github.com/ToruMakabe/Packer_Azure_Sample">Github</a>でご確認を。</p>

<p>これで手順書&amp;目視&amp;指差し確認でイメージ作るのを、やめられそうですね。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">09 Mar 2016, 16:30</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/azure_tf_fundamental_rules/" class="post-title">Terraform &amp; Azure デプロイ設計4原則</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>注: 2018/1/8にサンプルを更新しました。更新エントリは<a href="http://torumakabe.github.io/post/terraform_azure_sample_201801/">こちら</a>。</p>

<h2 id="情報がありそうでない">情報がありそうでない</h2>

<p><a href="http://torumakabe.github.io/post/azure_tf_arm_sp/">以前のエントリ</a>で書いたとおり、TerraformでAzureへデプロイする方式をClassicからResource Managerへ移行しているところです。</p>

<p>今後も継続して試行錯誤するとは思うのですが、ふらふらしないように原則を作りました。この手の情報はありそうでないので、参考になればと思いこのエントリを書いています。</p>

<p>なお、考え方は他のクラウドやデプロイツールでも応用できるかと。</p>

<h2 id="4原則">4原則</h2>

<ol>
<li>セキュリティファースト</li>
<li>手順書をなくそう</li>
<li>分割境界にこだわりすぎない</li>
<li>早すぎる最適化は悪</li>
</ol>

<p>なお、サンプルのTerraformファイル群を、<a href="https://github.com/ToruMakabe/Terraform_Azure_Sample">Githubに置いて</a>おきました。</p>

<p>今後ガラガラポンする可能性は大いにありますが、現時点ではこんな構造です。</p>

<pre><code>.
├── .gitignore
├── main.tf
├── availability_set
│   ├── avset_web.tf
│   ├── avset_db.tf
│   └── variables.tf
├── network
│   ├── sg_backend.tf
│   ├── sg_frontend.tf
│   ├── variables.tf
│   └── vnets.tf
├── storage
│   ├── storage_backend.tf
│   ├── storage_frontend.tf
│   └── variables.tf
└── terraform.tfvars
</code></pre>

<p>Availability Setに対するVMのデプロイはTerraformの外でやっています。まだTerraformのAzure RM Providerにない、ということもありますが、VMの増減はアドホックだったり、別ツールを使いたいケースが多いので。</p>

<h2 id="1-セキュリティファースト">1. セキュリティファースト</h2>

<p>セキュリティはデザイン時に考慮すべき時代です。機密情報が漏れないように、また、身内がうっかりリソースを壊して泣かないようにしましょう。</p>

<ul>
<li><p>認証情報は変数指定し、設定ファイルから読み込む</p>

<ul>
<li>サブスクリプションIDやOAuth Client ID/Secretなどを、リソースを作るtfファイルに書かない</li>
<li>terraform.tfvarsなどにまとめて書く</li>
</ul></li>

<li><p>認証情報や現物情報が入ったファイルはバージョン管理ツールから除外する</p>

<ul>
<li>Gitなら.gitignoreに指定する</li>
<li>.tfstateなど現物情報(Azure上のIDなど)が入る結果ファイルも除外

<ul>
<li>チームで使う場合はファイルではなく、Consulなどのリモートバックエンドを使うと思いますが、念のため</li>
</ul></li>
</ul></li>

<li><p>RBACで必要最小限の権限を付与する</p>

<ul>
<li>Terraformの外の話ですが、サービスプリンシパルを作る時には意識しましょう</li>
<li>身内がリソースをうっかり壊したら、それは管理者の責任です
<br /></li>
</ul></li>

<li><p>ネットワークセキュリティグループはサブネットに指定しておく</p>

<ul>
<li>個々のVMの管理者に任せず、サブネットで絞っておきましょう

<ul>
<li>VMはアドホックに作られるケースが多く、ルーズになりがちです</li>
</ul></li>
<li>サンプルではフロントエンドとバックエンドサブネットそれぞれにセキュリティグループを指定しています

<ul>
<li>フロントの受信はPort 80、443、22を許可 (できれば22はソースIP指定)</li>
<li>バックの受信はフロントサブネットからのみ許可 (Internetからの通信を deny all)</li>
</ul></li>
</ul></li>
</ul>

<h2 id="2-手順書をなくそう">2. 手順書をなくそう</h2>

<p>どうせなら手順書を無くす心意気でやりましょう。Infrastructure as Codeのメリットのひとつです。コードで手順を語りましょう。わかりやすさ重視です。</p>

<p>ドキュメントを否定する訳ではなく、コード化に至った背景、ポリシーや使い方、前提条件はドキュメント化し、あとはコードで語る。という世界観です。</p>

<h2 id="3-分割境界にこだわりすぎない">3. 分割境界にこだわりすぎない</h2>

<p>TerraformのModuleをはじめ、最近のデプロイツールはリソースや処理単位をグルーピングできます。ここがアーキテクトの腕の見せ所です。安易に「ベストプラクティス教えろや」という人は残念ながら残念です。大事なことなので2回言いました。</p>

<p>グルーピング、分割する目的は、</p>

<ul>
<li>main.tfの肥大化を防止し、コードの見通しを良くする</li>
<li>再利用しやすくする</li>
<li>責任範囲を明確化し、オーナー意識を醸成する</li>
<li>権限とコードを一致させる</li>
</ul>

<p>などが挙げられます。規模が小さく関わる人が少ないうちは無理して分割する必要はないですが、大きくなってくるとメリットがあります。</p>

<p>以下が分割単位、境界ポリシーの例です。</p>

<ul>
<li><p>リソースタイプで分割する</p>

<ul>
<li>サンプルはその例

<ul>
<li>ネットワーク、ストレージ、VM Availability Setで分割</li>
</ul></li>
<li>直観的</li>
<li>デプロイに関わる人数が少ない間はこれがおすすめ
<br /></li>
</ul></li>

<li><p>組織単位で分割する</p>

<ul>
<li><a href="https://ja.wikipedia.org/wiki/%E3%83%A1%E3%83%AB%E3%83%B4%E3%82%A3%E3%83%B3%E3%83%BB%E3%82%B3%E3%83%B3%E3%82%A6%E3%82%A7%E3%82%A4">コンウェイの法則</a></li>
<li>リソースタイプ = 組織 という場合もある

<ul>
<li>ネットワーク管理者が別グループ、など</li>
</ul></li>
</ul></li>

<li><p>地理的に分割する</p>

<ul>
<li>リージョンやロケーションで分割</li>
<li>リソースタイプと組み合わせる手もある

<ul>
<li>&ldquo;Network_JapanEast&rdquo;など
<br /></li>
</ul></li>
</ul></li>

<li><p>静的なリソースと動的なリソースを分ける</p>

<ul>
<li>変化の頻度で分ける

<ul>
<li>ネットワークが頻繁に変わることはまれ</li>
<li>VMは増減が激しい</li>
</ul></li>
<li>動的なリソースは対象から外す、別手段とする手も
<br /></li>
</ul></li>
</ul>

<p>スカッとしませんが、ひとつのポリシーにこだわらず、複数組み合わせてもいいと思います。そんな世界に僕らは生きています。</p>

<h2 id="4-早すぎる最適化は悪">4. 早すぎる最適化は悪</h2>

<p>最適化できる人 = その道のエキスパート です。使いはじめたばかりの段階では、最適化とか無理。また、システムの外部環境や制約がはじめから決まっていることは、まれです。</p>

<p>なので、はじめから「最強の構成」を目指さないほうがいいでしょう。特に分割方針。きっとすぐに変えたくなります。</p>

<p>ひとつのmain.tfで動かしながら、まずTerraformやAzureの仕様や挙動を理解しましょう。そして、慣れてきて、システムの外部環境や制約が見えてきた時点で分割方針を決めてもいいのではないか、と思います。</p>

<p>そして、</p>

<ul>
<li>リファクタリングできるなら、する</li>
<li>リファクタリングできなくても、理解の上で維持し機会を待つ、または、次の機会に活かす</li>
<li>はじめに作った人へマサカリを投げない</li>
</ul>

<p>完璧を求めずにいきましょう。</p>

<p>でも、しつこいですが、セキュリティだけは、はじめから意識してくださいね。Security by design。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">27 Feb 2016, 12:30</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/azure_tf_arm_sp/" class="post-title">TerraformをAzure ARMで使う時の認証</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="高まってまいりました">高まってまいりました</h2>

<p>全国10,000人のTerraformファンのみなさま、こんにちは。applyしてますか。</p>

<p>Terraformのマイナーバージョンアップのたびに、<a href="https://www.terraform.io/docs/providers/azurerm/index.html">Azure Resource Manager Providerのリソース</a>が追加されているので、ぼちぼちClassic(Service Management)からの移行を考えよう、という人もいるのでは。VMリソースが追加されたら、いよいよ、ですかね。</p>

<p>そこで、Classicとは認証方式が変わっているので、ご注意を、という話です。</p>

<h2 id="client-id-client-secret-って何よ">client_id/client_secret って何よ</h2>

<p>以下がARM向けのProvider設定です。</p>

<pre><code># Configure the Azure Resource Manager Provider
provider &quot;azurerm&quot; {
  subscription_id = &quot;...&quot;
  client_id       = &quot;...&quot;
  client_secret   = &quot;...&quot;
  tenant_id       = &quot;...&quot;
}
</code></pre>

<p>subscription_idは、いつものあれ。tenant_idは普段使わないけどどこかで見た気がする。でも、<strong>client_id/client_secret って何よ</strong>。ためしにポータルログインで使うID/パスワード指定したら、盛大にコケた。</p>

<pre><code>&quot;The provider needs to be configured with the credentials needed to generate OAuth tokens for the ARM API.&quot;
</code></pre>

<p>おっとそういうことか。OAuth。</p>

<h2 id="サービスプリンシパルを使おう">サービスプリンシパルを使おう</h2>

<p>Terraformをアプリケーションとして登録し、そのサービスプリンシパルを作成し権限を付与すると、使えるようになります。</p>

<p><a href="https://azure.microsoft.com/ja-jp/documentation/articles/active-directory-application-objects/">&ldquo;アプリケーション オブジェクトおよびサービス プリンシパル オブジェクト&rdquo;</a></p>

<p><a href="https://azure.microsoft.com/ja-jp/documentation/articles/resource-group-authenticate-service-principal/">&ldquo;Azure リソース マネージャーでのサービス プリンシパルの認証&rdquo;</a></p>

<p>以下、Azure CLIでの実行結果をのせておきます。WindowsでもMacでもLinuxでも手順は同じです。</p>

<p>まずは、Terraformをアプリとして登録します。&ndash;identifier-urisの存在チェックはないですが、ユニークにしなければいけません。また、&ndash;passwordはclient_secretになるので、おぼえておきましょう。</p>

<pre><code>$ azure ad app create --name &quot;My Terraform&quot; --home-page &quot;http://tftest.makabe.info&quot; --identifier-uris &quot;http://tftest.makabe.info&quot; --password pAssw0rd%
info:    Executing command ad app create
+ Creating application My Terraform
data:    AppId:                   AppId-AppId-AppId-AppId-AppId
data:    ObjectId:                AppObjId-AppObjId-AppObjId-AppObjId
data:    DisplayName:             My Terraform
data:    IdentifierUris:          0=http://tftest.makabe.info
data:    ReplyUrls:
data:    AvailableToOtherTenants:  False
data:    AppPermissions:
data:                             claimValue:  user_impersonation
data:                             description:  Allow the application to access My Terraform on behalf of the signed-in user.
data:                             directAccessGrantTypes:
data:                             displayName:  Access My Terraform
data:                             impersonationAccessGrantTypes:  impersonated=User, impersonator=Application
data:                             isDisabled:
data:                             origin:  Application
data:                             permissionId:  AppPermID-AppPermID-AppPermID-AppPermID
data:                             resourceScopeType:  Personal
data:                             userConsentDescription:  Allow the application to access My Terraform on your behalf.
data:                             userConsentDisplayName:  Access My Terraform
data:                             lang:
info:    ad app create command OK
</code></pre>

<p>次にサービスプリンシパルを作ります。AppIdは先ほどアプリを登録した際に生成されたものです。</p>

<pre><code>$ azure ad sp create AppId-AppId-AppId-AppId-AppId
info:    Executing command ad sp create
+ Creating service principal for application AppId-AppId-AppId-AppId-AppId
data:    Object Id:               SpObjId-SpObjId-SpObjId-SpObjId
data:    Display Name:            My Terraform
data:    Service Principal Names:
data:                             AppId-AppId-AppId-AppId-AppId
data:                             http://tftest.makabe.info
info:    ad sp create command OK
</code></pre>

<p>サービスプリンシパルの役割を設定します。&ndash;objectIdは、サービスプリンシパルのObject Idなのでご注意を。アプリのObject Idではありません。</p>

<p>この例では、サブスクリプションのContributorとして位置づけました。権限設定は慎重に。</p>

<pre><code>$ azure role assignment create --objectId SpObjId-SpObjId-SpObjId-SpObjId-SpObjId -o Contributor -c /subscriptions/SubId-SubId-SubId-SubId-SubId/
info:    Executing command role assignment create
+ Finding role with specified name
/data:    RoleAssignmentId     : /subscriptions/SubId-SubId-SubId-SubId-SubId/providers/Microsoft.Authorization/roleAssignments/RoleAsId-RoleAsId-RoleAsId-RoleAsId
data:    RoleDefinitionName   : Contributor
data:    RoleDefinitionId     : RoleDefId-RoleDefId-RoleDefId-RoleDefId-RoleDefId
data:    Scope                : /subscriptions/SubId-SubId-SubId-SubId-SubId
data:    Display Name         : My Terraform
data:    SignInName           :
data:    ObjectId             : SpObjId-SpObjId-SpObjId-SpObjId-SpObjId
data:    ObjectType           : ServicePrincipal
data:
+
info:    role assignment create command OK
</code></pre>

<p>サービスプリンシパルまわりの設定は以上です。</p>

<p>テナントIDを確認しておきましょう。</p>

<pre><code>$ azure account list --json
[
  {
    &quot;id&quot;: &quot;SubId-SubId-SubId-SubId-SubId&quot;,
    &quot;name&quot;: &quot;Your Subscription Name&quot;,
    &quot;user&quot;: {
      &quot;name&quot;: &quot;abc@microsoft.com&quot;,
      &quot;type&quot;: &quot;user&quot;
    },
    &quot;tenantId&quot;: &quot;TenantId-TenantId-TenantId-TenantId-TenantId&quot;,
    &quot;state&quot;: &quot;Enabled&quot;,
    &quot;isDefault&quot;: true,
    &quot;registeredProviders&quot;: [],
    &quot;environmentName&quot;: &quot;AzureCloud&quot;
  }
]
</code></pre>

<p>これでようやく.tfファイルが書けます。さくっとリソースグループでも作ってみましょう。</p>

<pre><code># Configure the Azure Resource Manager Provider
provider &quot;azurerm&quot; {
  subscription_id = &quot;SubId-SubId-SubId-SubId-SubId&quot;
  client_id       = &quot;AppId-AppId-AppId-AppId-AppId&quot;
  client_secret   = &quot;pAssw0rd%&quot;
  tenant_id       = &quot;TenantId-TenantId-TenantId-TenantId-TenantId&quot;
}

# Create a resource group
resource &quot;azurerm_resource_group&quot; &quot;test&quot; {
    name     = &quot;test&quot;
    location = &quot;Japan West&quot;
}
</code></pre>

<p>apply。もちろんplanしましたよ。</p>

<pre><code>$ terraform apply
azurerm_resource_group.test: Creating...
  location: &quot;&quot; =&gt; &quot;japanwest&quot;
  name:     &quot;&quot; =&gt; &quot;test&quot;
azurerm_resource_group.test: Creation complete

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.  
</code></pre>

<p>これで、ARM認証難民がうまれなくなりますように。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">15 Feb 2016, 17:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/azure_ddosprotection/" class="post-title">Azure DDoS対策ことはじめ</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="すこぶるfaq">すこぶるFAQ</h2>

<p>攻撃者の荒ぶり具合が高まっており、ご相談いただく機会が増えました。「どうすればいいか見当がつかない」というケースも少なくないので、DDoSに絞り、現時点で検討していただきたいことをシンプルにまとめます。</p>

<h2 id="公式ホワイトペーパー">公式ホワイトペーパー</h2>

<p><a href="http://download.microsoft.com/download/C/A/3/CA3FC5C0-ECE0-4F87-BF4B-D74064A00846/AzureNetworkSecurity_v3_Feb2015.pdf">Microsoft Azure Network Security Whitepaper V3</a>が、現時点でのMicrosoft公式見解です。DDoS以外にもセキュリティ関連で考慮すべきことがまとまっています。おすすめです。</p>

<p>今回はここから、DDoSに言及している部分を抜き出し意訳します。必要に応じて補足も入れます。</p>

<p><strong>2016//3/4 追記 <a href="http://download.microsoft.com/download/8/0/A/80ABD45E-BF1B-4235-A1C4-C8C43113CE70/AzureNetworkSecurity_v3_Mar2015.pdf">日本語訳</a>がありました</strong></p>

<h3 id="2-2-security-management-and-threat-defense-protecting-against-ddos">2.2 Security Management and Threat Defense - Protecting against DDoS</h3>

<pre><code>&quot;To protect Azure platform services, Microsoft provides a distributed denial-of-service (DDoS) defense system that is part of Azure’s continuous monitoring process, and is continually improved through penetration-testing. Azure’s DDoS defense system is designed to not only withstand attacks from the outside, but also from other Azure tenants:&quot;
</code></pre>

<p>MicrosoftはDDoSを防ぐ仕組みを提供しています。Azure外部からの攻撃はもちろんのこと、Azure内部で別テナントから攻撃されることも考慮しています。</p>

<h2 id="azureがやってくれること">Azureがやってくれること</h2>

<p>では、具体的に。</p>

<pre><code>&quot;1. Network-layer high volume attacks. These attacks choke network pipes and packet processing capabilities by flooding the network with packets. The Azure DDoS defense technology provides detection and mitigation techniques such as SYN cookies, rate limiting, and connection limits to help ensure that such attacks do not impact customer environments.&quot;
</code></pre>

<p>ネットワークレイヤで検知できる力押しは、AzureのDDoS防御システムが検知、緩和します。このホワイトペーパーのAppendixで図解されていますが、それはファイヤウォールの前段に配置され、SYN Cookieやレート制限、コネクション制限などのテクニックを使っています。</p>

<h2 id="お客様対応が必要なこと">お客様対応が必要なこと</h2>

<p>ですが、アプリケーションレイヤの攻撃は、AzureのDDoS防御システムだけでは防ぎきれません。お客様のアプリや通信の内容、要件まで踏み込めないからです。</p>

<pre><code>&quot;2. Application-layer attacks. These attacks can be launched against a customer VM. Azure does not provide mitigation or actively block network traffic affecting individual customer deployments, because the infrastructure does not interpret the expected behavior of customer applications. In this case, similar to on-premises deployments, mitigations include:&quot;
</code></pre>

<p>以下のような対処が有効です。</p>

<pre><code>&quot;Running multiple VM instances behind a load-balanced Public IP address.&quot;
</code></pre>

<p>攻撃されるポイントを負荷分散装置のパブリックIPに限定し、複数のVMへ負荷を散らします。 攻撃されても、できる限り踏ん張るアプローチです。AzureのDDoS防御システムで緩和しきれなかったトラフィックを受け止め、ダウンしないようにします。攻撃規模は事前に判断できないので、どれだけスケールさせるかは、ダウンした場合のビジネスインパクトとコストの兼ね合いで決める必要があります。</p>

<pre><code>&quot;Using firewall proxy devices such as Web Application Firewalls (WAFs) that terminate and forward traffic to endpoints running in a VM. This provides some protection against a broad range of DoS and other attacks, such as low-rate, HTTP, and other application-layer threats. Some virtualized solutions, such as Barracuda Networks, are available that perform both intrusion detection and prevention.&quot;
</code></pre>

<p>WAFを入れて、通信の中身を見ないとわからない攻撃を検知、緩和します。一見ノーマルなトラフィックでも「ゆっくりと攻撃」するようなケースもあります。たとえば、ゆっくりWebサーバのコネクションを枯渇させるような攻撃などです。Azureでは仮想アプライアンスとして、Barracuda NetworksのWAFなどが使えます。</p>

<pre><code>&quot; Web Server add-ons that protect against certain DoS attacks.&quot;
</code></pre>

<p>Webサーバへアドインを入れましょう。パッチも適用しましょう。構成も見直しましょう。ちょっと古いですが<a href="http://blogs.msdn.com/b/friis/archive/2014/12/30/security-guidelines-to-detect-and-prevent-dos-attacks-targeting-iis-azure-web-role-paas.aspx">ここ</a>が参考になります。</p>

<pre><code>&quot;Network ACLs, which can prevent packets from certain IP addresses from reaching VMs.&quot;
</code></pre>

<p>もしブロックしたいアクセス元IPアドレスがわかるなら、ACLで遮断しましょう。逆に通信可能な範囲のみ指定することもできます。</p>

<h2 id="ホワイトペーパーに加えて">ホワイトペーパーに加えて</h2>

<p><a href="https://azure.microsoft.com/ja-jp/services/cdn/">CDN</a>も有効ですので検討ください。2段構えでの負荷分散、防御ができます。Akamaiとの統合ソリューションも今後<a href="https://azure.microsoft.com/ja-jp/blog/microsoft-and-akamai-bring-cdn-to-azure-customers/">提供される予定</a>です。</p>

<p>CDNは常に世界中からのトラフィックで揉まれているだけあって、DDoS防御四天王で最強の漢が最初に出てくるくらい強力です。</p>

<p>最後に。攻撃されている感があれば、カスタマーサポートまで。</p>

                    </div>
                </section>
                
            </div>
            
<div class="pagination">
  <nav role="pagination" class="post-list-pagination">
      
      <a href="/categories/azure/page/5/" class="post-list-pagination-item pure-button post-list-pagination-item-prev">
        <i class="fa fa-angle-double-left"></i>&nbsp;Newer
      </a>
      
    <span class="post-list-pagination-item post-list-pagination-item-current">Page 6 of 8</span>
    
      <a href="/categories/azure/page/7/" class="post-list-pagination-item pure-button post-list-pagination-item-next">
        Older&nbsp;<i class="fa fa-angle-double-right"></i>
      </a>
    
  </nav>
</div>


            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="http://torumakabe.github.io//js/all.min.js"></script>
        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
