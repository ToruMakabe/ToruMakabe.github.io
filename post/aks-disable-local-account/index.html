<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>AKSのローカルアカウントを無効化しつつ、非対話型ログインを行う | re-imagine</title>

<meta property='og:title' content='AKSのローカルアカウントを無効化しつつ、非対話型ログインを行う - re-imagine'>
<meta property='og:description' content='何の話か Azure Kubernetes Service(AKS)でローカルアカウントを無効化できるようになり、GAしました。ローカルアカウントを無効にすると、AKSをセ'>
<meta property='og:url' content='https://ToruMakabe.github.io/post/aks-disable-local-account/'>
<meta property='og:site_name' content='re-imagine'>
<meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Azure'><meta property='article:tag' content='Kubernetes'><meta property='article:tag' content='AKS'><meta property='article:published_time' content='2021-12-26T15:00:00&#43;09:00'/><meta property='article:modified_time' content='2021-12-26T15:00:00&#43;09:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@tmak_tw'><meta name='twitter:creator' content='@tmak_tw'>


<link href="https://ToruMakabe.github.io/index.xml" rel="alternate" type="application/rss+xml" title="re-imagine" />

<link rel="stylesheet" href="/css/style.css"/><link rel='stylesheet' href='https://ToruMakabe.github.io/css/custom.css'><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://ToruMakabe.github.io/post/aks-disable-local-account/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://ToruMakabe.github.io/">
          <h1 id="nav-heading" class="title is-4">re-imagine</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/ToruMakabe'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/tmak_tw'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="instagram" href='https://instagram.com/torumakabe'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
    <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
    <line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="linkedin" href='https://linkedin.com/in/toru-makabe-b436b117'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/azure">#Azure</a>



  
  | <a class="subtitle is-6" href="/tags/kubernetes">#Kubernetes</a>
  
  | <a class="subtitle is-6" href="/tags/aks">#AKS</a>
  

      
    </div>
    <h2 class="subtitle is-6">December 26, 2021</h2>
    <h1 class="title">AKSのローカルアカウントを無効化しつつ、非対話型ログインを行う</h1>
    
    <div class="content">
      <h2 id="何の話か">何の話か</h2>
<p>Azure Kubernetes Service(AKS)で<a href="https://docs.microsoft.com/ja-jp/azure/aks/managed-aad#disable-local-accounts">ローカルアカウントを無効化できる</a>ようになり、<a href="https://azure.microsoft.com/ja-jp/updates/general-availability-create-aks-clusters-without-local-user-accounts-2/">GA</a>しました。ローカルアカウントを無効にすると、AKSをセキュアに運用しやすくなります。検討したいところです。</p>
<p>だがしかし。AKSの認証全般に言えるのですが、ドキュメントが難し目です。<a href="https://docs.microsoft.com/ja-jp/azure/aks/concepts-identity">前提知識</a>が多め、加えて、従来の手段やその組み合わせもカバーしているため、読む立場によっては混乱します。</p>
<p>また、ローカルアカウントを無効にした際の考慮点、特に影響が大きい非対話型ログインに関する説明が<a href="https://docs.microsoft.com/ja-jp/azure/aks/managed-aad#non-interactive-sign-in-with-kubelogin">淡白</a>です。</p>
<p>無効化の背景や影響、打ち手を整理したい。これが当記事の動機です。</p>
<h2 id="なぜ無効化できるようになったのか">なぜ無効化できるようになったのか</h2>
<p>ところで、ローカルアカウントという表現がピンとこないかもしれません。具体例は、ローカルに保存したクライアント証明書でAKSの認証ができる管理者アカウントです。&ldquo;az aks get-credentials&quot;コマンドを、&quot;&ndash;admin&quot;オプション付きで実行して取得する、あれです。</p>
<p>このコマンドは、クライアント証明書を配布する仕組みとしては有用です。いっぽうで、クライアント証明書があればAzure AD認証をパスできてしまうため、Azure ADの利点であるきめ細かな認証、監査ができません。加えて、証明書を無効にするためのローテーションも、気軽に実施できる作業ではありません。</p>
<p>そこで、<a href="https://docs.microsoft.com/ja-jp/azure/aks/managed-aad">AKSマネージドAzure AD統合</a>、<a href="https://docs.microsoft.com/ja-jp/azure/aks/manage-azure-rbac">AzureとKubernetesのRBAC統合</a>など、クライアント証明書認証無しでも運用できる仕組みが整ったいま、使えないようにしたい、というニーズが高まっています。これがローカルアカウントを無効化できるようになった背景です。</p>
<h2 id="無効化すると何が起こるのか">無効化すると何が起こるのか</h2>
<p>無効化は簡単です。Terraformであれば、<a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/kubernetes_cluster#local_account_disabled">local_account_disabled</a>で指定するだけです。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-HCL" data-lang="HCL">local_account_disabled <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</code></pre></div><p>なお、ローカルアカウントを封じてしまうため、管理者向けに別の認証手段が必要です。そこで、AKSマネージドAzure AD統合とRBAC統合を使います。Terraformであれば以下のように指定します。なお、admin_group_object_idsには、管理者ロールを付与したい、Azure ADグループのオブジェクトIDを指定します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-HCL" data-lang="HCL"><span style="color:#66d9ef">role_based_access_control</span> {
  enabled <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">azure_active_directory</span> {
    managed                <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
    azure_rbac_enabled     <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
    admin_group_object_ids <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;my-aad-group-object-id&#34;</span>]
  }
}
</code></pre></div><p>では実際にクラスターを作って、挙動や設定される内容を確認してみましょう。</p>
<p>この記事の作業者には、以下の設定を行っています。</p>
<ul>
<li>Azure RBAC: 作業者は、Azureのサブスクリプション所有者</li>
<li>Azure AD: 管理者向けグループを作り、作業者を登録</li>
<li>AKS: Azure ADに作った管理者向けグループを、admin_group_object_idsへ指定</li>
</ul>
<p>まず、Terraformで先述した設定にてクラスターを作ります（省略）。</p>
<p>では、作ったクラスターにアクセスして確かめてみましょう。</p>
<p>kubeconfigファイルが空っぽの状態からはじめます。ちなみに、kはkubectlのエイリアスです。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ k config get-contexts 
CURRENT   NAME   CLUSTER   AUTHINFO   NAMESPACE
$ cat ~/.kube/config 

</code></pre></div><p>まず、&ndash;adminオプションを使ったクレデンシャルの取得が封じられているかを確認します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ az aks get-credentials -g my-rg -n my-cluster --admin
<span style="color:#f92672">(</span>BadRequest<span style="color:#f92672">)</span> Getting static credential is not allowed because this cluster is set to disable local accounts.
Code: BadRequest
Message: Getting static credential is not allowed because this cluster is set to disable local accounts.
</code></pre></div><p>期待通り、使えなくなっていますね。</p>
<p>では、&ndash;adminオプション無しで実行します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ az aks get-credentials -g my-rg -n my-cluster
Merged <span style="color:#e6db74">&#34;my-cluster&#34;</span> as current context in /home/ubuntu/.kube/config

$ k config get-contexts 
CURRENT   NAME                           CLUSTER                        AUTHINFO                                                          NAMESPACE
*         my-cluster   my-cluster   clusterUser_my-rg_my-cluster 
</code></pre></div><p>何かを取得し、kubeconfigファイルのコンテキストにマージしたようです。その中身を見てみましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cat ~/.kube/config
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: <span style="color:#f92672">[</span>SENSITIVE<span style="color:#f92672">]</span>
    server: https://my-cluster.hcp.japaneast.azmk8s.io:443
  name: my-cluster
contexts:
- context:
    cluster: my-cluster
    user: clusterUser_my-rg_my-cluster
  name: my-cluster
current-context: my-cluster
kind: Config
preferences: <span style="color:#f92672">{}</span>
users:
- name: clusterUser_my-rg_my-cluster
  user:
    auth-provider:
      config:
        apiserver-id: 6dae42f8-4368-4678-94ff-3960e28e3630
        client-id: my-client-id
        config-mode: <span style="color:#e6db74">&#39;1&#39;</span>
        environment: AzurePublicCloud
        tenant-id: my-tenant-id
      name: azure
</code></pre></div><p>アクセス先のクラスターとユーザーに関する情報、その組み合わせであるコンテキストが生成されていますね。なお、.user.auth-provider.config.apiserver-idで設定されている &ldquo;6dae42f8-4368-4678-94ff-3960e28e3630&rdquo; は、AKSマネージドAzure AD統合機能を使うユーザーで共通のアプリケーションIDです。</p>
<p>このコンテキストでkubectlを使ってAKSクラスターへアクセスすると、Azure AD認証を求められます。試しにPodの一覧を取得してみましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ k get po
To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code 1234ABCD to authenticate.
No resources found in default namespace.
</code></pre></div><p>まずAzure AD認証が求められます。表示されたコードを使ってAzure AD認証を行なうと、Podの一覧を取得できました。Podは作っていないので、No resources foundでOKです。認証が成功し、defaultネームスペースのPodをリストできることがわかります。</p>
<p>この流れでは、Azure ADから得たトークン情報などがkubeconfigファイルにマージされます。以降、AKSはこのトークンで認証します。詳細は、<a href="https://docs.microsoft.com/ja-jp/azure/aks/concepts-identity#azure-ad-integration">公式ドキュメント</a>を参考にしてください。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cat ~/.kube/config
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: <span style="color:#f92672">[</span>SENSITIVE<span style="color:#f92672">]</span>
    server: https://my-cluster.hcp.japaneast.azmk8s.io:443
  name: my-cluster
contexts:
- context:
    cluster: my-cluster
    user: clusterUser_my-rg_my-cluster
  name: my-cluster
current-context: my-cluster
kind: Config
preferences: <span style="color:#f92672">{}</span>
users:
- name: clusterUser_my-rg_my-cluster
  user:
    auth-provider:
      config:
        access-token: <span style="color:#f92672">[</span>SENSITIVE<span style="color:#f92672">]</span>
        apiserver-id: 6dae42f8-4368-4678-94ff-3960e28e3630
        client-id: my-client-id
        config-mode: <span style="color:#e6db74">&#34;1&#34;</span>
        environment: AzurePublicCloud
        expires-in: <span style="color:#e6db74">&#34;3695&#34;</span>
        expires-on: <span style="color:#e6db74">&#34;1640327651&#34;</span>
        refresh-token: <span style="color:#f92672">[</span>SENSITIVE<span style="color:#f92672">]</span>
        tenant-id: my-tenant-id
      name: azure
</code></pre></div><p>なお、AKSクラスター上でこのユーザーがどのようにロール割り当てされているのかも、気になりますよね。見てみましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ k get clusterrolebindings aks-cluster-admin-binding-aad -o yaml 
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
...
  name: aks-cluster-admin-binding-aad
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: my-aad-group-object-id
</code></pre></div><p>Azure ADのグループIDに対して、cluster-adminロールが割り当てられています。</p>
<p>以上、AKSマネージドAzure ADとRBAC統合した環境で、ローカルアカウントを無効化した場合に何が起こるのか、大事なところをおさえました。</p>
<h2 id="非対話型ログインする方法">非対話型ログインする方法</h2>
<p>では2つ目のテーマです。ローカルアカウントを無効化すると、これまでクライアント証明書を使っていたツールに影響します。特に、Azure ADと対話型で認証できないツールが問題です。非対話型で実行したいワークフロー、ツールは多くあります。代表的なものは、GitHub ActionsやTerraformです。</p>
<p>例えばTerraformでKubernetesの設定を行うケースを考えてみましょう。<a href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/guides/getting-started#provider-setup">ドキュメントで紹介されているAKS向けプロバイダー設定</a>は、以下です。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-HCL" data-lang="HCL"><span style="color:#66d9ef">data</span> <span style="color:#e6db74">&#34;azurerm_kubernetes_cluster&#34; &#34;example&#34;</span> {
  name                <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;myakscluster&#34;</span>
  resource_group_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;my-example-resource-group&#34;</span>
}

<span style="color:#66d9ef">provider</span> <span style="color:#e6db74">&#34;kubernetes&#34;</span> {
  host                   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${data.azurerm_kubernetes_cluster.example.kube_config.0.host}&#34;</span>
  client_certificate     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${base64decode(data.azurerm_kubernetes_cluster.example.kube_config.0.client_certificate)}&#34;</span>
  client_key             <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${base64decode(data.azurerm_kubernetes_cluster.example.kube_config.0.client_key)}&#34;</span>
  cluster_ca_certificate <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${base64decode(data.azurerm_kubernetes_cluster.example.kube_config.0.cluster_ca_certificate)}&#34;</span>
}
</code></pre></div><p>しかし、AKSのローカルアカウントを無効化すると、client_keyとclient_certificateを取得できなくなります。つまりこの設定では認証できません。</p>
<p>ではどうすればいいでしょうか。ここで、Azureのドキュメントではあっさりした紹介にとどまっていた、<a href="https://github.com/Azure/kubelogin">kubelogin</a>を使います。</p>
<p>kubeloginは、<a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#client-go-credential-plugins">client-go credential プラグイン</a>のAzure向け実装です。client-goは代表的なKubernetesクライアントで、kubectlやTerraform Kubernetesプロバイダーでも使われています。kubeloginは、client-goがAzure ADからトークンなどのクレデンシャルを取得できるようサポートします。非対話型ログインはそのシナリオのひとつです。</p>
<p>使い方から入るとピンときやすいと思います。例えばTerraformのKubernetesプロバイダーでは、以下のように使います。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-HCL" data-lang="HCL"><span style="color:#66d9ef">provider</span> <span style="color:#e6db74">&#34;kubernetes&#34;</span> {
  host                   <span style="color:#f92672">=</span> <span style="color:#e6db74">${</span><span style="color:#960050;background-color:#1e0010">data</span>.<span style="color:#960050;background-color:#1e0010">azurerm_kubernetes_cluster</span>.<span style="color:#960050;background-color:#1e0010">example</span>.<span style="color:#960050;background-color:#1e0010">kube_config</span>.<span style="color:#960050;background-color:#1e0010">0</span>.<span style="color:#960050;background-color:#1e0010">host</span><span style="color:#e6db74">}</span><span style="color:#960050;background-color:#1e0010">&#34;</span>
  cluster_ca_certificate <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${base64decode(data.azurerm_kubernetes_cluster.example.kube_config.0.cluster_ca_certificate)}&#34;</span>

  <span style="color:#66d9ef">exec</span> {
    api_version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;client.authentication.k8s.io/v1beta1&#34;</span>
    command     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;kubelogin&#34;</span>
    args <span style="color:#f92672">=</span> [
      <span style="color:#e6db74">&#34;get-token&#34;</span>,
      <span style="color:#e6db74">&#34;--login&#34;</span>,
      <span style="color:#e6db74">&#34;azurecli&#34;</span>,
      <span style="color:#e6db74">&#34;--server-id&#34;</span>,
      <span style="color:#e6db74">&#34;6dae42f8-4368-4678-94ff-3960e28e3630&#34;</span>
    ]
  }
}
</code></pre></div><p>kubeloginは実行可能なプログラムです。パスを通し、client-goが実行できるようにしておきます。そして&quot;get-token&quot;は、Azure ADからトークンを得るサブコマンドです。また、&quot;&ndash;login azurecli&quot;オプションで、Azure CLIの認証情報を利用します。すでにAzure CLIでAzureにログインしている状態であれば、改めてAzure AD認証をする必要がありません。これが非対話型ログインできる理由です。</p>
<p>なお、kubeloginにはget-tokenの他に、convert-kubeconfigサブコマンドがあります。このサブコマンドは、kubedonfigファイルに、プラグインを使うように設定を書き込みます。例えばkubectlを非対話型ログインで使うことができる、というわけです。</p>
<p>ではconvert-kubeconfigサブコマンドも試してみましょう。kubeconfigファイルの変化を見たいため、az aks get-credentialsコマンドを&ndash;overwrite-existingオプションで実行し、すでに取得したトークンなど認証情報をリセットします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ az aks get-credentials -g my-rg -n my-cluster --overwrite-existing 
Merged <span style="color:#e6db74">&#34;my-cluster&#34;</span> as current context in /home/ubuntu/.kube/config

$ cat ~/.kube/config
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: <span style="color:#f92672">[</span>SENSITIVE<span style="color:#f92672">]</span>
    server: https://my-cluster.hcp.japaneast.azmk8s.io:443
  name: my-cluster
contexts:
- context:
    cluster: my-cluster
    user: clusterUser_my-rg_my-cluster
  name: my-cluster
current-context: my-cluster
kind: Config
preferences: <span style="color:#f92672">{}</span>
users:
- name: clusterUser_my-rg_my-cluster
  user:
    auth-provider:
      config:
        apiserver-id: 6dae42f8-4368-4678-94ff-3960e28e3630
        client-id: my-client-id
        config-mode: <span style="color:#e6db74">&#39;1&#39;</span>
        environment: AzurePublicCloud
        tenant-id: my-tenant-id
      name: azure
</code></pre></div><p>kubelogin convert-kubeconfigを実行し、kubeconfigファイルの変化を見ます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubelogin convert-kubeconfig --login azurecli --server-id 6dae42f8-4368-4678-94ff-3960e28e3630

$ cat ~/.kube/config
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: <span style="color:#f92672">[</span>SENSITIVE<span style="color:#f92672">]</span>
    server: https://my-cluster.hcp.japaneast.azmk8s.io:443
  name: my-cluster
contexts:
- context:
    cluster: my-cluster
    user: clusterUser_my-rg_my-cluster
  name: my-cluster
current-context: my-cluster
kind: Config
preferences: <span style="color:#f92672">{}</span>
users:
- name: clusterUser_my-rg_my-cluster
  user:
    exec:
      apiVersion: client.authentication.k8s.io/v1beta1
      args:
      - get-token
      - --server-id
      - 6dae42f8-4368-4678-94ff-3960e28e3630
      - --login
      - azurecli
      command: kubelogin
      env: null
      provideClusterInfo: false
</code></pre></div><p>先ほど見たTerraformと同様のプラグイン設定が入っていますね。これで、実行環境がAzure CLIで認証済みであれば、追加の認証なくkubectlを実行できる、というわけです。なお、kubeloginはAzure CLIだけでなくサービスプリンシパルやマネージドIDもサポートしています。必要に応じて<a href="https://github.com/Azure/kubelogin">確認</a>してください。</p>
<p>なお、非対話型ログインが必要なワークフローでは、kubeconfigファイルは普段使いとは分ける、または使い捨てることが多いでしょう。その場合、KUBECONFIG環境変数にkubeconfigファイルへのパスを設定し、kubeloginを実行してください。</p>
<h2 id="ワークフローのサンプル">ワークフローのサンプル</h2>
<p>ワークフローのサンプルとして、GitHub Actionsでの使い方を紹介しておきます。以下のIssueのコメントを参考にして下さい。ダウンロードするkubeloginのバージョンなど、見直しをお忘れなく。</p>
<blockquote>
<p><a href="https://github.com/Azure/aks-set-context/issues/25#issuecomment-846826239">Unable to use AAD Cluster with non-admin users</a></p>
</blockquote>

      
    </div>
    
  </div>
</section>



<section class="section">
  <div class="container has-text-centered">
    <p>&copy; Copyright 2021 Toru Makabe</p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>



</body>
</html>

