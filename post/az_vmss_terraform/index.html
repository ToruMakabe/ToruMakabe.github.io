<!DOCTYPE html>
<html><head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>AzureのAvailability Zonesへ分散するVMSSをTerraformで作る - re-imagine</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="動機 Terraform Azure Provider 1.3.0で、VMSSを作る際にAvailability Zonesを指定できるようになりました。Availability Zones" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="AzureのAvailability Zonesへ分散するVMSSをTerraformで作る" />
<meta property="og:description" content="動機 Terraform Azure Provider 1.3.0で、VMSSを作る際にAvailability Zonesを指定できるようになりました。Availability Zones" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ToruMakabe.github.io/post/az_vmss_terraform/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-03-26T00:08:30+09:00" />
<meta property="article:modified_time" content="2018-03-26T00:08:30+09:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="AzureのAvailability Zonesへ分散するVMSSをTerraformで作る"/>
<meta name="twitter:description" content="動機 Terraform Azure Provider 1.3.0で、VMSSを作る際にAvailability Zonesを指定できるようになりました。Availability Zones"/>
<script src="https://ToruMakabe.github.io/js/feather.min.js"></script>
	
	
        <link href="https://ToruMakabe.github.io/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://ToruMakabe.github.io/css/main.d1574b43a51792a446cd761d6f9b1c9abb39ed2c36ca6984f74aef729eb9f245.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://ToruMakabe.github.io/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css"  disabled />
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://ToruMakabe.github.io/">re-imagine</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/post">All posts</a>
		
		<a href="/tags">Tags</a>
		
		| <a id="dark-mode-toggle" onclick="toggleTheme()" href=""></a>
		<script src="https://ToruMakabe.github.io/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">AzureのAvailability Zonesへ分散するVMSSをTerraformで作る</h1>
			<div class="meta">Posted on Mar 26, 2018</div>
		</div>
		

		<section class="body">
			<h2 id="動機">動機</h2>
<p>Terraform Azure Provider 1.3.0で、VMSSを作る際にAvailability Zonesを指定できるように<a href="https://github.com/terraform-providers/terraform-provider-azurerm/pull/811">なりました</a>。Availability Zonesはインフラの根っこの仕組みなので、現在(2018/3)限定されたリージョンで長めのプレビュー期間がとられています。ですが、GAやグローバル展開を見据え、素振りしておきましょう。</p>
<h2 id="前提条件">前提条件</h2>
<ul>
<li>Availability Zones対応リージョンを選びます。現在は<a href="https://docs.microsoft.com/en-us/azure/availability-zones/az-overview#regions-that-support-availability-zones">5リージョン</a>です。この記事ではEast US 2とします。</li>
<li>Availability Zonesのプレビューに<a href="https://docs.microsoft.com/ja-jp/azure/availability-zones/az-overview">サインアップ</a>済みとします。</li>
<li>bashでsshの公開鍵が~/.ssh/id_rsa.pubにあると想定します。</li>
<li>動作確認した環境は以下です。
<ul>
<li>Terraform 0.11.2</li>
<li>Terraform Azure Provider 1.3.0</li>
<li>WSL (ubuntu 16.04)</li>
<li>macos (High Sierra 10.13.3)</li>
</ul>
</li>
</ul>
<h2 id="コード">コード</h2>
<p>以下のファイルを同じディレクトリに作成します。</p>
<h3 id="terraform-メインコード">Terraform メインコード</h3>
<p>VMSSと周辺リソースを作ります。</p>
<ul>
<li>最終行近くの &ldquo;zones = [1, 2, 3]&rdquo; がポイントです。これだけで、インスタンスを散らす先のゾーンを指定できます。</li>
<li>クロスゾーン負荷分散、冗長化するため、Load BalancerとパブリックIPのSKUをStandardにします。</li>
</ul>
<p>[main.tf]</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">resource &#34;azurerm_resource_group&#34; &#34;poc&#34; {
  name     = &#34;${var.resource_group_name}&#34;
  location = &#34;East US 2&#34;
}

resource &#34;azurerm_virtual_network&#34; &#34;poc&#34; {
  name                = &#34;vnet01&#34;
  resource_group_name = &#34;${azurerm_resource_group.poc.name}&#34;
  location            = &#34;${azurerm_resource_group.poc.location}&#34;
  address_space       = [&#34;10.0.0.0/16&#34;]
}

resource &#34;azurerm_subnet&#34; &#34;poc&#34; {
  name                      = &#34;subnet01&#34;
  resource_group_name       = &#34;${azurerm_resource_group.poc.name}&#34;
  virtual_network_name      = &#34;${azurerm_virtual_network.poc.name}&#34;
  address_prefix            = &#34;10.0.2.0/24&#34;
  network_security_group_id = &#34;${azurerm_network_security_group.poc.id}&#34;
}

resource &#34;azurerm_network_security_group&#34; &#34;poc&#34; {
  name                = &#34;nsg01&#34;
  resource_group_name = &#34;${azurerm_resource_group.poc.name}&#34;
  location            = &#34;${azurerm_resource_group.poc.location}&#34;

  security_rule = [
    {
      name                       = &#34;allow_http&#34;
      priority                   = 100
      direction                  = &#34;Inbound&#34;
      access                     = &#34;Allow&#34;
      protocol                   = &#34;Tcp&#34;
      source_port_range          = &#34;*&#34;
      destination_port_range     = &#34;80&#34;
      source_address_prefix      = &#34;*&#34;
      destination_address_prefix = &#34;*&#34;
    },
    {
      name                       = &#34;allow_ssh&#34;
      priority                   = 101
      direction                  = &#34;Inbound&#34;
      access                     = &#34;Allow&#34;
      protocol                   = &#34;Tcp&#34;
      source_port_range          = &#34;*&#34;
      destination_port_range     = &#34;22&#34;
      source_address_prefix      = &#34;*&#34;
      destination_address_prefix = &#34;*&#34;
    },
  ]
}

resource &#34;azurerm_public_ip&#34; &#34;poc&#34; {
  name                         = &#34;pip01&#34;
  resource_group_name          = &#34;${azurerm_resource_group.poc.name}&#34;
  location                     = &#34;${azurerm_resource_group.poc.location}&#34;
  public_ip_address_allocation = &#34;static&#34;
  domain_name_label            = &#34;${var.scaleset_name}&#34;

  sku = &#34;Standard&#34;
}

resource &#34;azurerm_lb&#34; &#34;poc&#34; {
  name                = &#34;lb01&#34;
  resource_group_name = &#34;${azurerm_resource_group.poc.name}&#34;
  location            = &#34;${azurerm_resource_group.poc.location}&#34;

  frontend_ip_configuration {
    name                 = &#34;fipConf01&#34;
    public_ip_address_id = &#34;${azurerm_public_ip.poc.id}&#34;
  }

  sku = &#34;Standard&#34;
}

resource &#34;azurerm_lb_backend_address_pool&#34; &#34;poc&#34; {
  name                = &#34;bePool01&#34;
  resource_group_name = &#34;${azurerm_resource_group.poc.name}&#34;
  loadbalancer_id     = &#34;${azurerm_lb.poc.id}&#34;
}

resource &#34;azurerm_lb_rule&#34; &#34;poc&#34; {
  name                           = &#34;lbRule&#34;
  resource_group_name            = &#34;${azurerm_resource_group.poc.name}&#34;
  loadbalancer_id                = &#34;${azurerm_lb.poc.id}&#34;
  protocol                       = &#34;Tcp&#34;
  frontend_port                  = 80
  backend_port                   = 80
  frontend_ip_configuration_name = &#34;fipConf01&#34;
  backend_address_pool_id        = &#34;${azurerm_lb_backend_address_pool.poc.id}&#34;
  probe_id                       = &#34;${azurerm_lb_probe.poc.id}&#34;
}

resource &#34;azurerm_lb_probe&#34; &#34;poc&#34; {
  name                = &#34;http-probe&#34;
  resource_group_name = &#34;${azurerm_resource_group.poc.name}&#34;
  loadbalancer_id     = &#34;${azurerm_lb.poc.id}&#34;
  port                = 80
}

resource &#34;azurerm_lb_nat_pool&#34; &#34;poc&#34; {
  count                          = 3
  name                           = &#34;ssh&#34;
  resource_group_name            = &#34;${azurerm_resource_group.poc.name}&#34;
  loadbalancer_id                = &#34;${azurerm_lb.poc.id}&#34;
  protocol                       = &#34;Tcp&#34;
  frontend_port_start            = 50000
  frontend_port_end              = 50119
  backend_port                   = 22
  frontend_ip_configuration_name = &#34;fipConf01&#34;
}

data &#34;template_cloudinit_config&#34; &#34;poc&#34; {
  gzip          = true
  base64_encode = true

  part {
    content_type = &#34;text/cloud-config&#34;
    content      = &#34;${file(&#34;${path.module}/cloud-config.yaml&#34;)}&#34;
  }
}

resource &#34;azurerm_virtual_machine_scale_set&#34; &#34;poc&#34; {
  name                = &#34;${var.scaleset_name}&#34;
  resource_group_name = &#34;${azurerm_resource_group.poc.name}&#34;
  location            = &#34;${azurerm_resource_group.poc.location}&#34;
  upgrade_policy_mode = &#34;Manual&#34;

  sku {
    name     = &#34;Standard_B1s&#34;
    tier     = &#34;Standard&#34;
    capacity = 3
  }

  storage_profile_image_reference {
    publisher = &#34;Canonical&#34;
    offer     = &#34;UbuntuServer&#34;
    sku       = &#34;16.04-LTS&#34;
    version   = &#34;latest&#34;
  }

  storage_profile_os_disk {
    name              = &#34;&#34;
    caching           = &#34;ReadWrite&#34;
    create_option     = &#34;FromImage&#34;
    managed_disk_type = &#34;Standard_LRS&#34;
  }

  os_profile {
    computer_name_prefix = &#34;pocvmss&#34;
    admin_username       = &#34;${var.admin_username}&#34;
    admin_password       = &#34;&#34;
    custom_data          = &#34;${data.template_cloudinit_config.poc.rendered}&#34;
  }

  os_profile_linux_config {
    disable_password_authentication = true

    ssh_keys {
      path     = &#34;/home/${var.admin_username}/.ssh/authorized_keys&#34;
      key_data = &#34;${file(&#34;~/.ssh/id_rsa.pub&#34;)}&#34;
    }
  }

  network_profile {
    name    = &#34;terraformnetworkprofile&#34;
    primary = true

    ip_configuration {
      name                                   = &#34;PoCIPConfiguration&#34;
      subnet_id                              = &#34;${azurerm_subnet.poc.id}&#34;
      load_balancer_backend_address_pool_ids = [&#34;${azurerm_lb_backend_address_pool.poc.id}&#34;]
      load_balancer_inbound_nat_rules_ids    = [&#34;${element(azurerm_lb_nat_pool.poc.*.id, count.index)}&#34;]
    }
  }

  zones = [1, 2, 3]
}
</code></pre></div><h3 id="cloud-init-configファイル">cloud-init configファイル</h3>
<p>各インスタンスがどのゾーンで動いているか確認したいので、インスタンス作成時にcloud-initでWebサーバーを仕込みます。メタデータからインスタンス名と実行ゾーンを引っ張り、nginxのドキュメントルートに書きます。</p>
<p>[cloud-config.yaml]</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">#cloud-config
package_upgrade: true
packages:
  - nginx
runcmd:
  - &#39;echo &#34;[Instance Name]: `curl -H Metadata:true &#34;http://169.254.169.254/metadata/instance/compute/name?api-version=2017-12-01&amp;format=text&#34;`    [Zone]: `curl -H Metadata:true &#34;http://169.254.169.254/metadata/instance/compute/zone?api-version=2017-12-01&amp;format=text&#34;`&#34; &gt; /var/www/html/index.nginx-debian.html&#39;
</code></pre></div><p>インスタンス作成時、パッケージの導入やアップデートに時間をかけたくない場合は、Packerなどで前もってカスタムイメージを作っておくのも手です。</p>
<ul>
<li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/build-image-with-packer">Packer を使用して Azure に Linux 仮想マシンのイメージを作成する方法</a></li>
<li><a href="https://docs.microsoft.com/ja-jp/azure/terraform/terraform-create-vm-scaleset-network-disks-using-packer-hcl">Terraform を使用して Packer カスタム イメージから Azure 仮想マシン スケール セットを作成する</a></li>
</ul>
<h3 id="terraform-変数ファイル">Terraform 変数ファイル</h3>
<p>変数は別ファイルへ。</p>
<p>[variables.tf]</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">variable &#34;resource_group_name&#34; {
  default = &#34;your-rg&#34;
}

variable &#34;scaleset_name&#34; {
  default = &#34;yourvmss01&#34;
}

variable &#34;admin_username&#34; {
  default = &#34;yourname&#34;
}
</code></pre></div><h2 id="実行">実行</h2>
<p>では実行。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ terraform init
$ terraform plan
$ terraform apply
</code></pre></div><p>5分くらいで完了しました。このサンプルでは、この後のcloud-initのパッケージ処理に時間がかかります。待てない場合は前述の通り、カスタムイメージを使いましょう。</p>
<p>インスタンスへのsshを通すよう、Load BalancerにNATを設定していますので、cloud-initの進捗は確認できます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ ssh -p 50000 yourname@yourvmss01.eastus2.cloudapp.azure.com
$ tail -f /var/log/cloud-init-output.log
Cloud-init v. 17.1 finished at Sun, 25 Mar 2018 10:41:40 +0000. Datasource DataSourceAzure [seed=/dev/sr0].  Up 611.51 seconds
</code></pre></div><p>ではWebサーバーにアクセスしてみましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ while true; do curl yourvmss01.eastus2.cloudapp.azure.com; sleep 1; done;
[Instance Name]: yourvmss01_2    [Zone]: 3
[Instance Name]: yourvmss01_0    [Zone]: 1
[Instance Name]: yourvmss01_2    [Zone]: 3
[Instance Name]: yourvmss01_1    [Zone]: 2
</code></pre></div><p>VMSSのインスタンスがゾーンに分散されたことが分かります。</p>
<p>では、このままスケールアウトしてみましょう。main.tfのazurerm_virtual_machine_scale_set.poc.sku.capacityを3から4にし、再度applyします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">[Instance Name]: yourvmss01_1    [Zone]: 2
[Instance Name]: yourvmss01_3    [Zone]: 1
[Instance Name]: yourvmss01_3    [Zone]: 1
[Instance Name]: yourvmss01_1    [Zone]: 2
[Instance Name]: yourvmss01_3    [Zone]: 1
</code></pre></div><p>ダウンタイムなしに、yourvmss01_3が追加されました。すこぶる簡単。</p>

		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/azure">Azure</a></li>
					
					<li><a href="/tags/az">AZ</a></li>
					
					<li><a href="/tags/vmss">VMSS</a></li>
					
					<li><a href="/tags/terraform">Terraform</a></li>
					
				</ul>
			</nav>
			
			
		</div>
	</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/ToruMakabe" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a><a class="soc" href="https://twitter.com/tmak_tw" title="Twitter"><i data-feather="twitter"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2022  Copyright 2021 Toru Makabe |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
  feather.replace()
</script></div>
    </body>
</html>
