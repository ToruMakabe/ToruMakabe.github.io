<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terraform &middot; re-imagine</title>

    <meta name="description" content="my life is the sum of my imagination">

    <meta name="generator" content="Hugo 0.14" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="tmak_tw" />
    <meta name="twitter:title" content="Terraform &middot; re-imagine">
    <meta name="twitter:description" content="my life is the sum of my imagination">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Terraform &middot; re-imagine">
    <meta property="og:description" content="my life is the sum of my imagination">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="http://torumakabe.github.io//css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="re-imagine" href="http://torumakabe.github.io//index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="http://torumakabe.github.io/">re-imagine</a></h1>
            <h2 class="brand-tagline"> my life is the sum of my imagination </h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/tmak_tw"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/ToruMakabe "><i class="fa fa-github-alt"></i> github</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="http://torumakabe.github.io//index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">27 Feb 2016, 12:30</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/azure_tf_arm_sp/" class="post-title">TerraformをAzure ARMで使う時の認証</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="高まってまいりました:dfc3556fff242cb82e1ca9532877c49b">高まってまいりました</h2>

<p>全国10,000人のTerraformファンのみなさま、こんにちは。applyしてますか。</p>

<p>Terraformのマイナーバージョンアップのたびに、<a href="https://www.terraform.io/docs/providers/azurerm/index.html">Azure Resource Manager Providerのリソース</a>が追加されているので、ぼちぼちClassic(Service Management)からの移行を考えよう、という人もいるのでは。VMリソースが追加されたら、いよいよ、ですかね。</p>

<p>そこで、Classicとは認証方式が変わっているので、ご注意を、という話です。</p>

<h2 id="client-id-client-secret-って何よ:dfc3556fff242cb82e1ca9532877c49b">client_id/client_secret って何よ</h2>

<p>以下がARM向けのProvider設定です。</p>

<pre><code># Configure the Azure Resource Manager Provider
provider &quot;azurerm&quot; {
  subscription_id = &quot;...&quot;
  client_id       = &quot;...&quot;
  client_secret   = &quot;...&quot;
  tenant_id       = &quot;...&quot;
}
</code></pre>

<p>subscription_idは、いつものあれ。tenant_idは普段使わないけどどこかで見た気がする。でも、<strong>client_id/client_secret って何よ</strong>。ためしにポータルログインで使うID/パスワード指定したら、盛大にコケた。</p>

<h2 id="サービスプリンシパルを使おう:dfc3556fff242cb82e1ca9532877c49b">サービスプリンシパルを使おう</h2>

<p>Terraformをアプリケーションとして登録し、そのサービスプリンシパルを作成し権限を付与すると、使えるようになります。</p>

<p><a href="https://azure.microsoft.com/ja-jp/documentation/articles/resource-group-authenticate-service-principal/#--azure-cli">&ldquo;Azure リソース マネージャーでのサービス プリンシパルの認証&rdquo;</a></p>

<p>以下、Azure CLIでの実行結果をのせておきます。WindowsでもMacでもLinuxでも手順は同じです。</p>

<p>まずは、Terraformをアプリとして登録します。&ndash;identifier-urisの存在チェックはないですが、ユニークにしなければいけません。また、&ndash;passwordはclient_secretになるので、おぼえておきましょう。</p>

<pre><code>$ azure ad app create --name &quot;My Terraform&quot; --home-page &quot;http://tftest.makabe.info&quot; --identifier-uris &quot;http://tftest.makabe.info&quot; --password pAssw0rd%
info:    Executing command ad app create
+ Creating application My Terraform
data:    AppId:                   AppId-AppId-AppId-AppId-AppId
data:    ObjectId:                AppObjId-AppObjId-AppObjId-AppObjId
data:    DisplayName:             My Terraform
data:    IdentifierUris:          0=http://tftest.makabe.info
data:    ReplyUrls:
data:    AvailableToOtherTenants:  False
data:    AppPermissions:
data:                             claimValue:  user_impersonation
data:                             description:  Allow the application to access My Terraform on behalf of the signed-in user.
data:                             directAccessGrantTypes:
data:                             displayName:  Access My Terraform
data:                             impersonationAccessGrantTypes:  impersonated=User, impersonator=Application
data:                             isDisabled:
data:                             origin:  Application
data:                             permissionId:  AppPermID-AppPermID-AppPermID-AppPermID
data:                             resourceScopeType:  Personal
data:                             userConsentDescription:  Allow the application to access My Terraform on your behalf.
data:                             userConsentDisplayName:  Access My Terraform
data:                             lang:
info:    ad app create command OK
</code></pre>

<p>次にサービスプリンシパルを作ります。AppIdは先ほどアプリを登録した際に生成されたものです。</p>

<pre><code>$ azure ad sp create AppId-AppId-AppId-AppId-AppId
info:    Executing command ad sp create
+ Creating service principal for application AppId-AppId-AppId-AppId-AppId
data:    Object Id:               SpObjId-SpObjId-SpObjId-SpObjId
data:    Display Name:            My Terraform
data:    Service Principal Names:
data:                             AppId-AppId-AppId-AppId-AppId
data:                             http://tftest.makabe.info
info:    ad sp create command OK
</code></pre>

<p>サービスプリンシパルの役割を設定します。&ndash;objectIdは、サービスプリンシパルのObject Idなのでご注意を。アプリのObject Idではありません。</p>

<p>この例では、サブスクリプションのContributorとして位置づけました。権限設定は慎重に。</p>

<pre><code>$ azure role assignment create --objectId SpObjId-SpObjId-SpObjId-SpObjId-SpObjId -o Contributor -c /subscriptions/SubId-SubId-SubId-SubId-SubId/
info:    Executing command role assignment create
+ Finding role with specified name
/data:    RoleAssignmentId     : /subscriptions/SubId-SubId-SubId-SubId-SubId/providers/Microsoft.Authorization/roleAssignments/RoleAsId-RoleAsId-RoleAsId-RoleAsId
data:    RoleDefinitionName   : Contributor
data:    RoleDefinitionId     : RoleDefId-RoleDefId-RoleDefId-RoleDefId-RoleDefId
data:    Scope                : /subscriptions/SubId-SubId-SubId-SubId-SubId
data:    Display Name         : My Terraform
data:    SignInName           :
data:    ObjectId             : SpObjId-SpObjId-SpObjId-SpObjId-SpObjId
data:    ObjectType           : ServicePrincipal
data:
+
info:    role assignment create command OK
</code></pre>

<p>サービスプリンシパルまわりの設定は以上です。</p>

<p>テナントIDを確認しておきましょう。</p>

<pre><code>$ azure account list --json
[
  {
    &quot;id&quot;: &quot;SubId-SubId-SubId-SubId-SubId&quot;,
    &quot;name&quot;: &quot;Your Subscription Name&quot;,
    &quot;user&quot;: {
      &quot;name&quot;: &quot;abc@microsoft.com&quot;,
      &quot;type&quot;: &quot;user&quot;
    },
    &quot;tenantId&quot;: &quot;TenantId-TenantId-TenantId-TenantId-TenantId&quot;,
    &quot;state&quot;: &quot;Enabled&quot;,
    &quot;isDefault&quot;: true,
    &quot;registeredProviders&quot;: [],
    &quot;environmentName&quot;: &quot;AzureCloud&quot;
  }
]
</code></pre>

<p>これでようやく.tfファイルが書けます。さくっとリソースグループでも作ってみましょう。</p>

<pre><code># Configure the Azure Resource Manager Provider
provider &quot;azurerm&quot; {
  subscription_id = &quot;SubId-SubId-SubId-SubId-SubId&quot;
  client_id       = &quot;AppId-AppId-AppId-AppId-AppId&quot;
  client_secret   = &quot;pAssw0rd%&quot;
  tenant_id       = &quot;TenantId-TenantId-TenantId-TenantId-TenantId&quot;
}

# Create a resource group
resource &quot;azurerm_resource_group&quot; &quot;test&quot; {
    name     = &quot;test&quot;
    location = &quot;Japan West&quot;
}
</code></pre>

<p>apply。もちろんplanしましたよ。</p>

<pre><code>$ terraform apply
azurerm_resource_group.test: Creating...
  location: &quot;&quot; =&gt; &quot;japanwest&quot;
  name:     &quot;&quot; =&gt; &quot;test&quot;
azurerm_resource_group.test: Creation complete

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.  
</code></pre>

<p>これで、ARM認証難民がうまれなくなりますように。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">04 Apr 2015, 00:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/terraform-openstack-minimum/" class="post-title">いきなり Terraform OpenStack Provider</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h3 id="terraform-0-4でopenstack-providerリリース:5f9dbf3eb73e084c7453e28119859d69">Terraform 0.4でOpenStack Providerリリース</h3>

<p>以前からOpenStack対応は表明されていたのですが、いよいよ<a href="https://hashicorp.com/blog/terraform-0-4.html">v0.4</a>でリリースされました。</p>

<h3 id="小さくはじめましょう:5f9dbf3eb73e084c7453e28119859d69">小さくはじめましょう</h3>

<p>この手のツールを試すときは、はじめから欲張ると苦労します。最小限の設定でひとまず動かすとクイックに幸せが訪れます。目標は10分。</p>

<h3 id="テストした環境:5f9dbf3eb73e084c7453e28119859d69">テストした環境</h3>

<ul>
<li>Terraform 0.4</li>
<li>Mac OS 10.10.2</li>
<li>HP Helion Public Cloud</li>
</ul>

<h3 id="openstackerのみだしなみ-環境変数:5f9dbf3eb73e084c7453e28119859d69">OpenStackerのみだしなみ、環境変数</h3>

<p>下記、環境変数はセットされてますよね。要確認。</p>

<ul>
<li>OS_AUTH_URL<br /></li>
<li>OS_USERNAME<br /></li>
<li>OS_PASSWORD<br /></li>
<li>OS_REGION_NAME<br /></li>
<li>OS_TENANT_NAME<br /></li>
</ul>

<h3 id="最小限の構成ファイル:5f9dbf3eb73e084c7453e28119859d69">最小限の構成ファイル</h3>

<p><script type="text/javascript" src="http://gist.github.com/977209064bcfda66d085.js"></script></p>

<p>これだけ。Providerの設定は書かなくていいです。Terraformは環境変数を見に行きます。Resource部は、最小限ということで、まずはインスタンスを起動し、Floating IPをつけるとこまで持っていきましょう。</p>

<h3 id="さあ実行:5f9dbf3eb73e084c7453e28119859d69">さあ実行</h3>

<p>まずはterraform planコマンドで、実行計画を確認します。</p>

<pre><code>$ terraform plan
Refreshing Terraform state prior to plan...


The Terraform execution plan has been generated and is shown below.
Resources are shown in alphabetical order for quick scanning. Green resources
will be created (or destroyed and then created if an existing resource exists), yellow resources are being changed in-place, and red resources will be destroyed.

Note: You didn't specify an &quot;-out&quot; parameter to save this plan, so when &quot;apply&quot; is called, Terraform can't guarantee this is what will execute.

+ openstack_compute_instance_v2.sample-server
    access_ip_v4:      &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
    access_ip_v6:      &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
    flavor_id:         &quot;&quot; =&gt; &quot;my_flavor_id&quot;
    flavor_name:       &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
    floating_ip:       &quot;&quot; =&gt; &quot;aaa.bbb.ccc.ddd&quot;
    image_id:          &quot;&quot; =&gt; &quot;my_image_id&quot;
    image_name:        &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
    key_pair:          &quot;&quot; =&gt; &quot;my_keypair&quot;
    name:              &quot;&quot; =&gt; &quot;tf-sample&quot;
    network.#:         &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
    region:            &quot;&quot; =&gt; &quot;my_region&quot;
    security_groups.#: &quot;&quot; =&gt; &quot;1&quot;
    security_groups.0: &quot;&quot; =&gt; &quot;my_sg&quot;
</code></pre>

<p>定義通りに動きそうですね。では実行。applyです。</p>

<pre><code>$ terraform apply  
openstack_compute_instance_v2.sample-server: Creating...  
    access_ip_v4:      &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;  
    access_ip_v6:      &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;  
    flavor_id:         &quot;&quot; =&gt; &quot;my_flavor&quot;  
    flavor_name:       &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;  
    floating_ip:       &quot;&quot; =&gt; &quot;aaa.bbb.ccc.ddd&quot;  
    image_id:          &quot;&quot; =&gt; &quot;my_image_id&quot;  
    image_name:        &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;  
    key_pair:          &quot;&quot; =&gt; &quot;my_keypair&quot;  
    name:              &quot;&quot; =&gt; &quot;tf-sample&quot;  
    network.#:         &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;  
    region:            &quot;&quot; =&gt; &quot;my_region&quot;
    security_groups.#: &quot;&quot; =&gt; &quot;1&quot;
    security_groups.0: &quot;&quot; =&gt; &quot;my_sg&quot;
openstack_compute_instance_v2.test-server: Creation complete

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.

The state of your infrastructure has been saved to the path below. This state is required to modify and destroy your infrastructure, so keep it safe. To inspect the complete state use the `terraform show` command.
</code></pre>

<p>とても楽ちんですね。あとはオプションを追加して込み入った構成に挑戦してみてください。</p>

                    </div>
                </section>
                
            </div>
            

            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="http://torumakabe.github.io//js/all.min.js"></script>
        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
