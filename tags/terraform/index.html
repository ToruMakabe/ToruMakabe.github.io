<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terraform &middot; re-imagine</title>

    <meta name="description" content="my life is the sum of my imagination">

    <meta name="generator" content="Hugo 0.14" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="tmak_tw" />
    <meta name="twitter:title" content="Terraform &middot; re-imagine">
    <meta name="twitter:description" content="my life is the sum of my imagination">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Terraform &middot; re-imagine">
    <meta property="og:description" content="my life is the sum of my imagination">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="http://torumakabe.github.io//css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="re-imagine" href="http://torumakabe.github.io//index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="http://torumakabe.github.io/">re-imagine</a></h1>
            <h2 class="brand-tagline"> my life is the sum of my imagination </h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/tmak_tw"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/ToruMakabe "><i class="fa fa-github-alt"></i> github</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="http://torumakabe.github.io//index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">25 Mar 2016, 22:50</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/azure_terraform_earlyphase_tips/" class="post-title">Azure &amp; Terraform Tips (ARM対応 2016春版)</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="俺の屍を越えていけ:9776a375b7d12db77e52b9c8d97b8677">俺の屍を越えていけ</h2>

<p>今週リリースされたTerraform v0.6.14で、Azure Resource Manager ProviderのリソースにVMとテンプレートデプロイが<a href="https://github.com/hashicorp/terraform/blob/v0.6.14/CHANGELOG.md">追加</a>されました。この週末お楽しみ、という人も多いかもしれません。</p>

<p>小生、v0.6.14以前から触っていたこともあり、土地勘があります。そこで現時点でのTipsをいくつかご紹介します。</p>

<h2 id="この3つは触る前から意識しよう:9776a375b7d12db77e52b9c8d97b8677">この3つは触る前から意識しよう</h2>

<ol>
<li>ARMテンプレートリソースは分離して使う</li>
<li>リソース競合したら依存関係を定義する</li>
<li>公開鍵認証SSH指定でエラーが出ても驚かない</li>
</ol>

<h2 id="1-armテンプレートリソースは分離して使う:9776a375b7d12db77e52b9c8d97b8677">1. ARMテンプレートリソースは分離して使う</h2>

<p>v0.6.14で、リソース<a href="https://www.terraform.io/docs/providers/azurerm/r/template_deployment.html">&ldquo;azurerm_template_deployment&rdquo;</a>が追加されました。なんとARMテンプレートを、Terraformの定義ファイル内にインラインで書けます。</p>

<p>でも、現時点の実装では、おすすめしません。</p>

<h3 id="armテンプレートのデプロイ機能とterraformで作ったリソースが不整合を起こす:9776a375b7d12db77e52b9c8d97b8677">ARMテンプレートのデプロイ機能とTerraformで作ったリソースが不整合を起こす</h3>

<p>避けるべきなのは&rdquo;Complete(完全)&ldquo;モードでのARMテンプレートデプロイです。なぜなら完全モードでは、ARM リソースマネージャーは次の動きをするからです。</p>

<p><strong><a href="https://azure.microsoft.com/ja-jp/documentation/articles/resource-group-template-deploy/">リソース グループに存在するが、テンプレートに指定されていないリソースを削除します</a></strong></p>

<p>つまり、ARMテンプレートで作ったリソース以外、Terraform担当部分を消しにいきます。恐怖! デプロイ vs デプロイ!!。リソースグループを分ければ回避できますが、リスク高めです。</p>

<h3 id="タイムアウトしがち:9776a375b7d12db77e52b9c8d97b8677">タイムアウトしがち</h3>

<p>それでもTerraformの外でARMテンプレートデプロイは継続します。成功すれば結果オーライですが&hellip;Terraform上はエラーが残ります。「ああそれ無視していいよ」ではあるのですが、<a href="https://ja.wikipedia.org/wiki/%E5%89%B2%E3%82%8C%E7%AA%93%E7%90%86%E8%AB%96">割れ窓理論</a>的によろしくないです。</p>

<h3 id="せっかくのリソースグラフを活用できない:9776a375b7d12db77e52b9c8d97b8677">せっかくのリソースグラフを活用できない</h3>

<p>Terraformはグラフ構造で賢くリソース間の依存関係を管理し、整合性を維持しています。サクサク apply &amp; destroyできるのもそれのおかげです。ARMテンプレートでデプロイしたリソースはそれに入れられないので、もったいないです。</p>

<h3 id="読みづらい:9776a375b7d12db77e52b9c8d97b8677">読みづらい</h3>

<p>Terraform DSLにJSONが混ざって読みにくいです。Terraform DSLを使わない手もありますが、それでいいのかという話です。</p>

<p>それでも&rdquo;terraformコマンドに操作を統一したい&rdquo;など、どうしても使いたい人は、ARMテンプレート実行部は管理も実行も分離した方がいいと思います。</p>

<h2 id="2-リソース競合したら依存関係を定義する:9776a375b7d12db77e52b9c8d97b8677">2. リソース競合したら依存関係を定義する</h2>

<p>Terraformはリソース間の依存関係を明示する必要がありません。ですが、行き届かないこともあります。その場合は<a href="https://www.terraform.io/intro/getting-started/dependencies.html">&ldquo;depends_on&rdquo;</a>で明示してあげましょう。</p>

<p>例えば、<a href="http://torumakabe.github.io/post/azure_terraform_429_workaround/">以前のエントリ</a>で紹介した下記の問題。</p>

<pre><code>Error applying plan:

1 error(s) occurred:
azurerm_virtual_network.vnet1: autorest:DoErrorUnlessStatusCode 429 PUT https://management.azure.com/subscriptions/my_subscription_id/resourceGroups/mygroup/providers/Microsoft.Network/virtualnetworks/vnet1?api-version=2015-06-15 failed with 429


Cannot proceed with operation since resource /subscriptions/GUID/resourceGroups/xxxx/providers/Microsoft.Network/networkSecurityGroups/yyy allocated to resource /subscriptions/GUID/resourceGroups/***/providers/Microsoft.Network/virtualNetworks/yyy is not in Succeeded state. Resource is in Updating state and the last operation that updated/is updating the resource is PutSecurityRuleOperation. 
</code></pre>

<p>HTTPステータスコード429(Too many requests)が返ってきているのでわかりにくいですが、実態はセキュリティーグループリソースの取り合いです。</p>

<ul>
<li>サブネットリソース作成側: サブネットを新規作成し、セキュリティーグループを紐付けたい</li>
<li>セキュリティーグループルール作成側: ルールをセキュリティーグループに登録したい(更新処理)</li>
</ul>

<p>この2つが並行してセキュリティーグループを取り合うので、高確率でエラーになります。セキュリティーグループルールはリソースの新規作成でなく、セキュリティーグループの更新処理であるため「リソースを<strong>作成したら/存在したら</strong>次にすすむ」というTerraformのグラフでうまく表現できないようです。</p>

<p>そのような場合、明示的に依存関係を&rdquo;depends_on&rdquo;で定義します。</p>

<pre><code># Create a frontend subnet
# &quot;depends_on&quot; arg is a workaround to avoid conflict with updating NSG rules 
resource &quot;azurerm_subnet&quot; &quot;frontend&quot; {
    name = &quot;frontend&quot;
    resource_group_name = &quot;${var.resource_group_name}&quot;
    virtual_network_name = &quot;${azurerm_virtual_network.vnet1.name}&quot;
    address_prefix = &quot;${var.vnet1_frontend_address_prefix}&quot;
    network_security_group_id = &quot;${azurerm_network_security_group.frontend.id}&quot;
    depends_on = [
        &quot;azurerm_network_security_rule.fe_web80&quot;,
        &quot;azurerm_network_security_rule.fe_web443&quot;,
        &quot;azurerm_network_security_rule.fe_ssh&quot;
    ]
}
</code></pre>

<p>これでサブネット作成処理は、セキュリティーグループルール登録完了まで、作成処理開始を待ちます。美しくないですが、当面の回避策です。</p>

<h2 id="3-公開鍵認証ssh指定でエラーが出ても驚かない:9776a375b7d12db77e52b9c8d97b8677">3. 公開鍵認証SSH指定でエラーが出ても驚かない</h2>

<p>TerraformはLinux VMの定義で、公開鍵認証SSHを指定できます。こんな感じで。</p>

<pre><code>os_profile_linux_config {
    disable_password_authentication = true
    ssh_keys {
        path = &quot;/home/${var.adminuser}/.ssh/authorized_keys&quot;
        key_data = &quot;${file(&quot;/Users/you/.ssh/yourkey.pem&quot;)}&quot;
    }
}
</code></pre>

<p>が、エラーが返ってきます。</p>

<pre><code>[DEBUG] Error setting Virtual Machine Storage OS Profile Linux Configuration: &amp;errors.errorString{s:&quot;Invalid address to set: []string{\&quot;os_profile_linux_config\&quot;, \&quot;12345678\&quot;, \&quot;ssh_keys\&quot;}&quot;}
</code></pre>

<p>残念ながら、Terraformが使っているAzure SDK(Golang)のバグです。</p>

<p>妥当性チェックのエラーで、実際にはキーの登録はできているようです。私は何度か試行してすべて公開鍵SSHログインに成功しています。</p>

<p><a href="https://github.com/hashicorp/terraform/issues/5793">Issueとして認識</a>されていますので、修正を待ちましょう。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">23 Mar 2016, 13:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/azure_terraform_429_workaround/" class="post-title">Azure &amp; Terraform エラーコード429の対処法</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="terraformer増加に備えて:41e5563e03314499a86e746f2fbd113b">Terraformer増加に備えて</h2>

<p>2016/3/21にリリースされたTerraform v0.6.14で、Azure Resource Manager ProviderのリソースにVMとテンプレートデプロイが<a href="https://github.com/hashicorp/terraform/blob/v0.6.14/CHANGELOG.md">追加</a>されました。待っていた人も多いのではないでしょうか。</p>

<p>追って<a href="https://www.hashicorp.com/partners.html#sipart">Hashicorp認定パートナー</a>のクリエーションラインさんから導入・サポートサービスが<a href="http://www.creationline.com/lab/13268">アナウンス</a>されましたし、今後AzureをTerraformでコントロールしようという需要は増えそうです。</p>

<h2 id="エラーコード429:41e5563e03314499a86e746f2fbd113b">エラーコード429</h2>

<p>さて、TerraformでAzureをいじっていると、下記のようなエラーに出くわすことがあります。</p>

<pre><code>Error applying plan:

1 error(s) occurred:
azurerm_virtual_network.vnet1: autorest:DoErrorUnlessStatusCode 429 PUT https://management.azure.com/subscriptions/my_subscription_id/resourceGroups/mygroup/providers/Microsoft.Network/virtualnetworks/vnet1?api-version=2015-06-15 failed with 429
</code></pre>

<p>autorestがステータスコード429をキャッチしました。<a href="https://tools.ietf.org/html/rfc6585#section-4">RFC上で429は</a>&ldquo;Too many requests&rdquo;です。何かが多すぎたようです。</p>

<h2 id="対処法:41e5563e03314499a86e746f2fbd113b">対処法</h2>

<p><strong>もう一度applyしてください</strong></p>

<p>冪等性最高。冪等性なんていらない、という人もいますが、こういうときはありがたい。Terraformが作成に失敗したリソースのみ再作成します。</p>

<h2 id="背景:41e5563e03314499a86e746f2fbd113b">背景</h2>

<p>エラーになった背景ですが、2つの可能性があります。</p>

<ol>
<li>APIリクエスト数上限に達した</li>
<li>リソースの作成や更新に時間がかかっており、Azure側で処理を中断した</li>
</ol>

<h3 id="1-apiリクエスト数上限に達した:41e5563e03314499a86e746f2fbd113b">1. APIリクエスト数上限に達した</h3>

<p>Azure Resource Manager APIには時間当たりのリクエスト数制限があります。読み取り 15,000/時、書き込み1,200/時です。</p>

<p><strong><a href="https://azure.microsoft.com/ja-jp/documentation/articles/azure-subscription-service-limits/">Azure サブスクリプションとサービスの制限、クォータ、制約</a></strong></p>

<p>Terraformは扱うリソースごとにAPIをコールするので、数が多い環境で作って壊してをやると、この上限にひっかかる可能性があります。</p>

<p>長期的な対処として、Terraformにリトライ/Exponential Backoffロジックなどを実装してもらうのがいいのか、このままユーザ側でシンプルにリトライすべきか、悩ましいところです。</p>

<p>ひとまずプロダクトの方針は確認したいので、Issueに質問を<a href="https://github.com/hashicorp/terraform/issues/5704">あげておきました</a>。</p>

<h3 id="2-リソースの作成や更新に時間がかかっており-azure側で処理を中断した:41e5563e03314499a86e746f2fbd113b">2. リソースの作成や更新に時間がかかっており、Azure側で処理を中断した</h3>

<p>Terraform側ではエラーコードで判断するしかありませんが、Azureの監査ログで詳細が確認できます。</p>

<p>わたしが経験したエラーの中に、こんなものがありました。</p>

<pre><code>Cannot proceed with operation since resource /subscriptions/GUID/resourceGroups/xxxx/providers/Microsoft.Network/networkSecurityGroups/yyy allocated to resource /subscriptions/GUID/resourceGroups/***/providers/Microsoft.Network/virtualNetworks/yyy is not in Succeeded state. Resource is in Updating state and the last operation that updated/is updating the resource is PutSecurityRuleOperation. 
</code></pre>

<p>Too many requestsというよりは、リソースのアップデートが終わってないので先に進めない、という内容です。</p>

<p>Too many requestsをどう解釈するかにもよりますが、ちょっと混乱しますね。この問題はFeedbackとして<a href="https://feedback.azure.com/forums/34192--general-feedback/suggestions/13069563-better-http-status-code-instead-of-429">あがっています</a>。</p>

<p>でも安心してください。<strong>もう一度applyしてください</strong>。</p>

<p><strong>(2016/3/25 追記) 回避策を<a href="http://torumakabe.github.io/post/azure_terraform_earlyphase_tips/">別エントリ</a>に書きました</strong></p>

                    </div>
                </section>
                
                <h1 class="content-subhead">09 Mar 2016, 16:30</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/azure_tf_fundamental_rules/" class="post-title">Terraform &amp; Azure デプロイ設計4原則</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="情報がありそうでない:d303628c574d6be5ce0911be72b7a9a0">情報がありそうでない</h2>

<p><a href="http://torumakabe.github.io/post/azure_tf_arm_sp/">以前のエントリ</a>で書いたとおり、TerraformでAzureへデプロイする方式をClassicからResource Managerへ移行しているところです。</p>

<p>今後も継続して試行錯誤するとは思うのですが、ふらふらしないように原則を作りました。この手の情報はありそうでないので、参考になればと思いこのエントリを書いています。</p>

<p>なお、考え方は他のクラウドやデプロイツールでも応用できるかと。</p>

<h2 id="4原則:d303628c574d6be5ce0911be72b7a9a0">4原則</h2>

<ol>
<li>セキュリティファースト</li>
<li>手順書をなくそう</li>
<li>分割境界にこだわりすぎない</li>
<li>早すぎる最適化は悪</li>
</ol>

<p>なお、サンプルのTerraformファイル群を、<a href="https://github.com/ToruMakabe/Terraform_Azure_Sample">Githubに置いて</a>おきました。</p>

<p>今後ガラガラポンする可能性は大いにありますが、現時点ではこんな構造です。</p>

<pre><code>.
├── .gitignore
├── main.tf
├── availability_set
│   ├── avset_web.tf
│   ├── avset_db.tf
│   └── variables.tf
├── network
│   ├── sg_backend.tf
│   ├── sg_frontend.tf
│   ├── variables.tf
│   └── vnets.tf
├── storage
│   ├── storage_backend.tf
│   ├── storage_frontend.tf
│   └── variables.tf
└── terraform.tfvars
</code></pre>

<p>Availability Setに対するVMのデプロイはTerraformの外でやっています。まだTerraformのAzure RM Providerにない、ということもありますが、VMの増減はアドホックだったり、別ツールを使いたいケースが多いので。</p>

<h2 id="1-セキュリティファースト:d303628c574d6be5ce0911be72b7a9a0">1. セキュリティファースト</h2>

<p>セキュリティはデザイン時に考慮すべき時代です。機密情報が漏れないように、また、身内がうっかりリソースを壊して泣かないようにしましょう。</p>

<ul>
<li><p>認証情報は変数指定し、設定ファイルから読み込む</p>

<ul>
<li>サブスクリプションIDやOAuth Client ID/Secretなどを、リソースを作るtfファイルに書かない</li>
<li>terraform.tfvarsなどにまとめて書く</li>
</ul></li>

<li><p>認証情報や現物情報が入ったファイルはバージョン管理ツールから除外する</p>

<ul>
<li>Gitなら.gitignoreに指定する</li>
<li>.tfstateなど現物情報(Azure上のIDなど)が入る結果ファイルも除外

<ul>
<li>チームで使う場合はファイルではなく、Consulなどのリモートバックエンドを使うと思いますが、念のため</li>
</ul></li>
</ul></li>

<li><p>RBACで必要最小限の権限を付与する</p>

<ul>
<li>Terraformの外の話ですが、サービスプリンシパルを作る時には意識しましょう</li>
<li>身内がリソースをうっかり壊したら、それは管理者の責任です</li>
</ul></li>

<li><p>ネットワークセキュリティグループはサブネットに指定しておく</p>

<ul>
<li>個々のVMの管理者に任せず、サブネットで絞っておきましょう

<ul>
<li>VMはアドホックに作られるケースが多く、ルーズになりがちです</li>
</ul></li>
<li>サンプルではフロントエンドとバックエンドサブネットそれぞれにセキュリティグループを指定しています

<ul>
<li>フロントの受信はPort 80、443、22を許可 (できれば22はソースIP指定)</li>
<li>バックの受信はフロントサブネットからのみ許可 (Internetからの通信を deny all)</li>
</ul></li>
</ul></li>
</ul>

<h2 id="2-手順書をなくそう:d303628c574d6be5ce0911be72b7a9a0">2. 手順書をなくそう</h2>

<p>どうせなら手順書を無くす心意気でやりましょう。Infrastructure as Codeのメリットのひとつです。コードで手順を語りましょう。わかりやすさ重視です。</p>

<p>ポリシーや使い方、前提条件をリポジトリのREADMEに書いておけばOK、あとはコードで語る。という世界を目指したいものです。</p>

<h2 id="3-分割境界にこだわりすぎない:d303628c574d6be5ce0911be72b7a9a0">3. 分割境界にこだわりすぎない</h2>

<p>TerraformのModuleをはじめ、最近のデプロイツールはリソースや処理単位をグルーピングできます。ここがアーキテクトの腕の見せ所です。安易に「ベストプラクティス教えろや」という人は残念ながら残念です。大事なことなので2回言いました。</p>

<p>グルーピング、分割する目的は、</p>

<ul>
<li>main.tfの肥大化を防止し、コードの見通しを良くする</li>
<li>再利用しやすくする</li>
<li>責任範囲を明確化し、オーナー意識を醸成する</li>
<li>権限とコードを一致させる</li>
</ul>

<p>などが挙げられます。規模が小さく関わる人が少ないうちは無理して分割する必要はないですが、大きくなってくるとメリットがあります。</p>

<p>以下が分割単位、境界ポリシーの例です。</p>

<ul>
<li><p>リソースタイプで分割する</p>

<ul>
<li>サンプルはその例

<ul>
<li>ネットワーク、ストレージ、VM Availability Setで分割</li>
</ul></li>
<li>直観的</li>
<li>デプロイに関わる人数が少ない間はこれがおすすめ</li>
</ul></li>

<li><p>組織単位で分割する</p>

<ul>
<li><a href="https://ja.wikipedia.org/wiki/%E3%83%A1%E3%83%AB%E3%83%B4%E3%82%A3%E3%83%B3%E3%83%BB%E3%82%B3%E3%83%B3%E3%82%A6%E3%82%A7%E3%82%A4">コンウェイの法則</a></li>
<li>リソースタイプ = 組織 という場合もある

<ul>
<li>ネットワーク管理者が別グループ、など</li>
</ul></li>
</ul></li>

<li><p>地理的に分割する</p>

<ul>
<li>リージョンやロケーションで分割</li>
<li>リソースタイプと組み合わせる手もある

<ul>
<li>&ldquo;Network_JapanEast&rdquo;など</li>
</ul></li>
</ul></li>

<li><p>静的なリソースと動的なリソースを分ける</p>

<ul>
<li>変化の頻度で分ける

<ul>
<li>ネットワークが頻繁に変わることはまれ</li>
<li>VMは増減が激しい</li>
</ul></li>
<li>動的なリソースは対象から外す、別手段とする手も</li>
</ul></li>
</ul>

<p>スカッとしませんが、ひとつのポリシーにこだわらず、複数組み合わせてもいいと思います。そんな世界に僕らは生きています。</p>

<h2 id="4-早すぎる最適化は悪:d303628c574d6be5ce0911be72b7a9a0">4. 早すぎる最適化は悪</h2>

<p>最適化できる人 = その道のエキスパート です。使いはじめたばかりの段階では、最適化とか無理。また、システムの外部環境や制約がはじめから決まっていることは、まれです。</p>

<p>なので、はじめから「最強の構成」を目指さないほうがいいでしょう。特に分割方針。きっとすぐに変えたくなります。</p>

<p>ひとつのmain.tfで動かしながら、まずTerraformやAzureの仕様や挙動を理解しましょう。そして、慣れてきて、システムの外部環境や制約が見えてきた時点で分割方針を決めてもいいのではないか、と思います。</p>

<p>そして、</p>

<ul>
<li>リファクタリングできるなら、する</li>
<li>リファクタリングできなくても、理解の上で維持し機会を待つ、または、次の機会に活かす</li>
<li>はじめに作った人へマサカリを投げない</li>
</ul>

<p>完璧を求めずにいきましょう。</p>

<p>でも、しつこいですが、セキュリティだけは、はじめから意識してくださいね。Security by design。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">27 Feb 2016, 12:30</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/azure_tf_arm_sp/" class="post-title">TerraformをAzure ARMで使う時の認証</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="高まってまいりました:dfc3556fff242cb82e1ca9532877c49b">高まってまいりました</h2>

<p>全国10,000人のTerraformファンのみなさま、こんにちは。applyしてますか。</p>

<p>Terraformのマイナーバージョンアップのたびに、<a href="https://www.terraform.io/docs/providers/azurerm/index.html">Azure Resource Manager Providerのリソース</a>が追加されているので、ぼちぼちClassic(Service Management)からの移行を考えよう、という人もいるのでは。VMリソースが追加されたら、いよいよ、ですかね。</p>

<p>そこで、Classicとは認証方式が変わっているので、ご注意を、という話です。</p>

<h2 id="client-id-client-secret-って何よ:dfc3556fff242cb82e1ca9532877c49b">client_id/client_secret って何よ</h2>

<p>以下がARM向けのProvider設定です。</p>

<pre><code># Configure the Azure Resource Manager Provider
provider &quot;azurerm&quot; {
  subscription_id = &quot;...&quot;
  client_id       = &quot;...&quot;
  client_secret   = &quot;...&quot;
  tenant_id       = &quot;...&quot;
}
</code></pre>

<p>subscription_idは、いつものあれ。tenant_idは普段使わないけどどこかで見た気がする。でも、<strong>client_id/client_secret って何よ</strong>。ためしにポータルログインで使うID/パスワード指定したら、盛大にコケた。</p>

<pre><code>&quot;The provider needs to be configured with the credentials needed to generate OAuth tokens for the ARM API.&quot;
</code></pre>

<p>おっとそういうことか。OAuth。</p>

<h2 id="サービスプリンシパルを使おう:dfc3556fff242cb82e1ca9532877c49b">サービスプリンシパルを使おう</h2>

<p>Terraformをアプリケーションとして登録し、そのサービスプリンシパルを作成し権限を付与すると、使えるようになります。</p>

<p><a href="https://azure.microsoft.com/ja-jp/documentation/articles/active-directory-application-objects/">&ldquo;アプリケーション オブジェクトおよびサービス プリンシパル オブジェクト&rdquo;</a></p>

<p><a href="https://azure.microsoft.com/ja-jp/documentation/articles/resource-group-authenticate-service-principal/">&ldquo;Azure リソース マネージャーでのサービス プリンシパルの認証&rdquo;</a></p>

<p>以下、Azure CLIでの実行結果をのせておきます。WindowsでもMacでもLinuxでも手順は同じです。</p>

<p>まずは、Terraformをアプリとして登録します。&ndash;identifier-urisの存在チェックはないですが、ユニークにしなければいけません。また、&ndash;passwordはclient_secretになるので、おぼえておきましょう。</p>

<pre><code>$ azure ad app create --name &quot;My Terraform&quot; --home-page &quot;http://tftest.makabe.info&quot; --identifier-uris &quot;http://tftest.makabe.info&quot; --password pAssw0rd%
info:    Executing command ad app create
+ Creating application My Terraform
data:    AppId:                   AppId-AppId-AppId-AppId-AppId
data:    ObjectId:                AppObjId-AppObjId-AppObjId-AppObjId
data:    DisplayName:             My Terraform
data:    IdentifierUris:          0=http://tftest.makabe.info
data:    ReplyUrls:
data:    AvailableToOtherTenants:  False
data:    AppPermissions:
data:                             claimValue:  user_impersonation
data:                             description:  Allow the application to access My Terraform on behalf of the signed-in user.
data:                             directAccessGrantTypes:
data:                             displayName:  Access My Terraform
data:                             impersonationAccessGrantTypes:  impersonated=User, impersonator=Application
data:                             isDisabled:
data:                             origin:  Application
data:                             permissionId:  AppPermID-AppPermID-AppPermID-AppPermID
data:                             resourceScopeType:  Personal
data:                             userConsentDescription:  Allow the application to access My Terraform on your behalf.
data:                             userConsentDisplayName:  Access My Terraform
data:                             lang:
info:    ad app create command OK
</code></pre>

<p>次にサービスプリンシパルを作ります。AppIdは先ほどアプリを登録した際に生成されたものです。</p>

<pre><code>$ azure ad sp create AppId-AppId-AppId-AppId-AppId
info:    Executing command ad sp create
+ Creating service principal for application AppId-AppId-AppId-AppId-AppId
data:    Object Id:               SpObjId-SpObjId-SpObjId-SpObjId
data:    Display Name:            My Terraform
data:    Service Principal Names:
data:                             AppId-AppId-AppId-AppId-AppId
data:                             http://tftest.makabe.info
info:    ad sp create command OK
</code></pre>

<p>サービスプリンシパルの役割を設定します。&ndash;objectIdは、サービスプリンシパルのObject Idなのでご注意を。アプリのObject Idではありません。</p>

<p>この例では、サブスクリプションのContributorとして位置づけました。権限設定は慎重に。</p>

<pre><code>$ azure role assignment create --objectId SpObjId-SpObjId-SpObjId-SpObjId-SpObjId -o Contributor -c /subscriptions/SubId-SubId-SubId-SubId-SubId/
info:    Executing command role assignment create
+ Finding role with specified name
/data:    RoleAssignmentId     : /subscriptions/SubId-SubId-SubId-SubId-SubId/providers/Microsoft.Authorization/roleAssignments/RoleAsId-RoleAsId-RoleAsId-RoleAsId
data:    RoleDefinitionName   : Contributor
data:    RoleDefinitionId     : RoleDefId-RoleDefId-RoleDefId-RoleDefId-RoleDefId
data:    Scope                : /subscriptions/SubId-SubId-SubId-SubId-SubId
data:    Display Name         : My Terraform
data:    SignInName           :
data:    ObjectId             : SpObjId-SpObjId-SpObjId-SpObjId-SpObjId
data:    ObjectType           : ServicePrincipal
data:
+
info:    role assignment create command OK
</code></pre>

<p>サービスプリンシパルまわりの設定は以上です。</p>

<p>テナントIDを確認しておきましょう。</p>

<pre><code>$ azure account list --json
[
  {
    &quot;id&quot;: &quot;SubId-SubId-SubId-SubId-SubId&quot;,
    &quot;name&quot;: &quot;Your Subscription Name&quot;,
    &quot;user&quot;: {
      &quot;name&quot;: &quot;abc@microsoft.com&quot;,
      &quot;type&quot;: &quot;user&quot;
    },
    &quot;tenantId&quot;: &quot;TenantId-TenantId-TenantId-TenantId-TenantId&quot;,
    &quot;state&quot;: &quot;Enabled&quot;,
    &quot;isDefault&quot;: true,
    &quot;registeredProviders&quot;: [],
    &quot;environmentName&quot;: &quot;AzureCloud&quot;
  }
]
</code></pre>

<p>これでようやく.tfファイルが書けます。さくっとリソースグループでも作ってみましょう。</p>

<pre><code># Configure the Azure Resource Manager Provider
provider &quot;azurerm&quot; {
  subscription_id = &quot;SubId-SubId-SubId-SubId-SubId&quot;
  client_id       = &quot;AppId-AppId-AppId-AppId-AppId&quot;
  client_secret   = &quot;pAssw0rd%&quot;
  tenant_id       = &quot;TenantId-TenantId-TenantId-TenantId-TenantId&quot;
}

# Create a resource group
resource &quot;azurerm_resource_group&quot; &quot;test&quot; {
    name     = &quot;test&quot;
    location = &quot;Japan West&quot;
}
</code></pre>

<p>apply。もちろんplanしましたよ。</p>

<pre><code>$ terraform apply
azurerm_resource_group.test: Creating...
  location: &quot;&quot; =&gt; &quot;japanwest&quot;
  name:     &quot;&quot; =&gt; &quot;test&quot;
azurerm_resource_group.test: Creation complete

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.  
</code></pre>

<p>これで、ARM認証難民がうまれなくなりますように。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">04 Apr 2015, 00:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/terraform-openstack-minimum/" class="post-title">いきなり Terraform OpenStack Provider</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h3 id="terraform-0-4でopenstack-providerリリース:5f9dbf3eb73e084c7453e28119859d69">Terraform 0.4でOpenStack Providerリリース</h3>

<p>以前からOpenStack対応は表明されていたのですが、いよいよ<a href="https://hashicorp.com/blog/terraform-0-4.html">v0.4</a>でリリースされました。</p>

<h3 id="小さくはじめましょう:5f9dbf3eb73e084c7453e28119859d69">小さくはじめましょう</h3>

<p>この手のツールを試すときは、はじめから欲張ると苦労します。最小限の設定でひとまず動かすとクイックに幸せが訪れます。目標は10分。</p>

<h3 id="テストした環境:5f9dbf3eb73e084c7453e28119859d69">テストした環境</h3>

<ul>
<li>Terraform 0.4</li>
<li>Mac OS 10.10.2</li>
<li>HP Helion Public Cloud</li>
</ul>

<h3 id="openstackerのみだしなみ-環境変数:5f9dbf3eb73e084c7453e28119859d69">OpenStackerのみだしなみ、環境変数</h3>

<p>下記、環境変数はセットされてますよね。要確認。</p>

<ul>
<li>OS_AUTH_URL<br /></li>
<li>OS_USERNAME<br /></li>
<li>OS_PASSWORD<br /></li>
<li>OS_REGION_NAME<br /></li>
<li>OS_TENANT_NAME<br /></li>
</ul>

<h3 id="最小限の構成ファイル:5f9dbf3eb73e084c7453e28119859d69">最小限の構成ファイル</h3>

<p><script type="text/javascript" src="http://gist.github.com/977209064bcfda66d085.js"></script></p>

<p>これだけ。Providerの設定は書かなくていいです。Terraformは環境変数を見に行きます。Resource部は、最小限ということで、まずはインスタンスを起動し、Floating IPをつけるとこまで持っていきましょう。</p>

<h3 id="さあ実行:5f9dbf3eb73e084c7453e28119859d69">さあ実行</h3>

<p>まずはterraform planコマンドで、実行計画を確認します。</p>

<pre><code>$ terraform plan
Refreshing Terraform state prior to plan...


The Terraform execution plan has been generated and is shown below.
Resources are shown in alphabetical order for quick scanning. Green resources
will be created (or destroyed and then created if an existing resource exists), yellow resources are being changed in-place, and red resources will be destroyed.

Note: You didn't specify an &quot;-out&quot; parameter to save this plan, so when &quot;apply&quot; is called, Terraform can't guarantee this is what will execute.

+ openstack_compute_instance_v2.sample-server
    access_ip_v4:      &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
    access_ip_v6:      &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
    flavor_id:         &quot;&quot; =&gt; &quot;my_flavor_id&quot;
    flavor_name:       &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
    floating_ip:       &quot;&quot; =&gt; &quot;aaa.bbb.ccc.ddd&quot;
    image_id:          &quot;&quot; =&gt; &quot;my_image_id&quot;
    image_name:        &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
    key_pair:          &quot;&quot; =&gt; &quot;my_keypair&quot;
    name:              &quot;&quot; =&gt; &quot;tf-sample&quot;
    network.#:         &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
    region:            &quot;&quot; =&gt; &quot;my_region&quot;
    security_groups.#: &quot;&quot; =&gt; &quot;1&quot;
    security_groups.0: &quot;&quot; =&gt; &quot;my_sg&quot;
</code></pre>

<p>定義通りに動きそうですね。では実行。applyです。</p>

<pre><code>$ terraform apply  
openstack_compute_instance_v2.sample-server: Creating...  
    access_ip_v4:      &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;  
    access_ip_v6:      &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;  
    flavor_id:         &quot;&quot; =&gt; &quot;my_flavor&quot;  
    flavor_name:       &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;  
    floating_ip:       &quot;&quot; =&gt; &quot;aaa.bbb.ccc.ddd&quot;  
    image_id:          &quot;&quot; =&gt; &quot;my_image_id&quot;  
    image_name:        &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;  
    key_pair:          &quot;&quot; =&gt; &quot;my_keypair&quot;  
    name:              &quot;&quot; =&gt; &quot;tf-sample&quot;  
    network.#:         &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;  
    region:            &quot;&quot; =&gt; &quot;my_region&quot;
    security_groups.#: &quot;&quot; =&gt; &quot;1&quot;
    security_groups.0: &quot;&quot; =&gt; &quot;my_sg&quot;
openstack_compute_instance_v2.test-server: Creation complete

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.

The state of your infrastructure has been saved to the path below. This state is required to modify and destroy your infrastructure, so keep it safe. To inspect the complete state use the `terraform show` command.
</code></pre>

<p>とても楽ちんですね。あとはオプションを追加して込み入った構成に挑戦してみてください。</p>

                    </div>
                </section>
                
            </div>
            

            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="http://torumakabe.github.io//js/all.min.js"></script>
        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
