<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linux &middot; re-imagine</title>

    <meta name="description" content="my life is the sum of my imagination">

    <meta name="generator" content="Hugo 0.14" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="tmak_tw" />
    <meta name="twitter:title" content="Linux &middot; re-imagine">
    <meta name="twitter:description" content="my life is the sum of my imagination">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Linux &middot; re-imagine">
    <meta property="og:description" content="my life is the sum of my imagination">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="http://torumakabe.github.io//css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="re-imagine" href="http://torumakabe.github.io//index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="http://torumakabe.github.io/">re-imagine</a></h1>
            <h2 class="brand-tagline"> my life is the sum of my imagination </h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/tmak_tw"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/ToruMakabe "><i class="fa fa-github-alt"></i> github</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="http://torumakabe.github.io//index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">27 Jan 2016, 00:19</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/striping_linuxonazure/" class="post-title">Linux on AzureでDisk IO性能を確保する方法</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="俺の鉄板-ができるまで:cfa04af83b137faef18a5d4e4444f400">&ldquo;俺の鉄板&rdquo;ができるまで</h2>

<p>前半はポエムです。おそらくこのエントリたどり着く人の期待はLinux on AzureのDisk IO性能についてと思いますが、それは後半に書きます。</p>

<p>クラウド、Azureに関わらず、技術や製品の組み合わせは頭の痛い問題です。「これとこれ、組み合わせて動くの？サポートされるの？性能出るの？」という、あれです。技術や製品はどんどん進化しますので、同じ組み合わせが使えることは珍しくなってきています。</p>

<p>ちなみにお客様のシステムを設計する機会が多いわたしは、こんな流れで検討します。</p>

<ol>
<li>構成要素全体を俯瞰したうえで、調査が必要な技術や製品、ポイントを整理する

<ul>
<li>やみくもに調べものしないように</li>
<li>経験あるアーキテクトは実績ある組み合わせや落とし穴を多くストックしているので、ここが早い</li>
</ul></li>
<li>ベンダの公式資料を確認する

<ul>
<li>「この使い方を推奨/サポートしています」と明記されていれば安心</li>
<li>でも星の数ほどある技術や製品との組み合わせがすべて網羅されているわけではない</li>
<li>不明確なら早めに問い合わせる</li>
</ul></li>
<li>ベンダが運営しているコミュニティ上の情報を確認する

<ul>
<li>ベンダの正式見解ではない場合もあるが、その製品を担当する社員が書いている情報には信ぴょう性がある</li>
</ul></li>
<li>コミュニティや有識者の情報を確認する

<ul>
<li>OSSでは特に</li>
<li>専門性を感じるサイト、人はリストしておく</li>
</ul></li>
<li>動かす

<ul>
<li>やっぱり動かしてみないと</li>
</ul></li>
<li>提案する

<ul>
<li>リスクがあれば明示します</li>
</ul></li>
<li>問題なければ実績になる、問題があればリカバリする

<ul>
<li>提案しっぱなしにせずフォローすることで、自信とパターンが増える</li>
<li>次の案件で活きる</li>
</ul></li>
</ol>

<p>いまのわたしの課題は４、5です。特にOSS案件。AzureはOSSとの組み合わせを推進していて、ここ半年でぐっと情報増えたのですが、まだ物足りません。断片的な情報を集め、仮説を立て、動かす機会が多い。なので、5を増やして、4の提供者側にならんとなぁ、と。</p>

<h2 id="linux-on-azureでdisk-io性能を確保する方法:cfa04af83b137faef18a5d4e4444f400">Linux on AzureでDisk IO性能を確保する方法</h2>

<p>さて今回の主題です。</p>

<p>結論: Linux on AzureでDisk IOを最大化するには、MDによるストライピングがおすすめ。いくつかパラメータを意識する。</p>

<p>Linux on AzureでDisk IO性能を必要とする案件がありました。検討したアイデアは、SSDを採用したPremium Storageを複数束ねてのストライピングです。Premium Storageはディスクあたり5,000IOPSを期待できます。でも、それで足りない恐れがありました。なので複数並べて平行アクセスし、性能を稼ぐ作戦です。</p>

<p>サーバ側でのソフトウェアストライピングは古くからあるテクニックで、ハードの能力でブン殴れそうなハイエンドUnixサーバとハイエンドディスクアレイを組み合わせた案件でも、匠の技として使われています。キャッシュやアレイコントローラ頼りではなく、明示的にアクセスを分散することで性能を確保することができます。</p>

<p>Linuxで使える代表的なストライプ実装は、LVMとMD。</p>

<p>ではAzure上でどちらがを選択すべきでしょう。この案件では性能が優先事項です。わたしはその時点で判断材料を持っていませんでした。要調査。この絞り込みまでが前半ポエムの1です。</p>

<p>前半ポエムの2、3はググ、もといBing力が試される段階です。わたしは以下の情報にたどり着きました。</p>

<p><a href="https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-linux-configure-raid/">&ldquo;Configure Software RAID on Linux&rdquo;</a></p>

<p><a href="https://azure.microsoft.com/ja-jp/documentation/articles/storage-premium-storage-preview-portal/#premium-storage">&ldquo;Premium Storage: Azure 仮想マシン ワークロード向けの高パフォーマンス ストレージ&rdquo;</a></p>

<p><a href="http://blogs.msdn.com/b/igorpag/archive/2014/10/23/azure-storage-secrets-and-linux-i-o-optimizations.aspx">&ldquo;Azure Storage secrets and Linux I/O optimizations&rdquo;</a></p>

<p>得られた情報の中で大事なのは、</p>

<ul>
<li>公式ドキュメントで

<ul>
<li>LVMではなくMDを使った構成例が紹介されている</li>
</ul></li>
<li>マイクロソフトがホストするブログ(MSDN)で、エキスパートが

<ul>
<li>LVMと比較したうえで、MDをすすめている</li>
<li>MDのChunkサイズについて推奨値を紹介している</li>
<li>そのほか、ファイルシステムやスケジューラに関する有益な情報あり</li>
</ul></li>
</ul>

<p>なるほど。わたしのこの時点での方針はこうです。</p>

<ul>
<li>LVMを使う必然性はないため、MDに絞る

<ul>
<li>LVMのほうが機能豊富だが、目的はストライピングだけであるため、シンプルなほうを</li>
<li>物理障害対策はAzureに任せる (3コピー)</li>
</ul></li>
<li>MDのChunkをデフォルトの512KBから64KBに変更する</li>
<li>Premium StorageのキャッシュはReadOnly or Noneにする予定であるため、ファイルシステムのバリアを無効にする</li>
</ul>

<p>上記シナリオで、ディスク当たり5,000IOPS、ストライプ数に比例した性能が実際出れば提案価値あり、ということになります。
ですが、ズバリな実績値が見つからない。ダラダラ探すのは時間の無駄。これは自分でやるしかない。</p>

<p>構成手順は前述のリンク先にありますが、ポイントを抜き出します。OS=Ubuntu、ファイルシステム=ext4の場合です。</p>

<p>MDでストライプを作る際、チャンクを64KBに変更します。</p>

<pre><code>sudo mdadm --create /dev/md127 --level 0 --raid-devices 2  /dev/sdc1 /dev/sdd1 -c 64k
</code></pre>

<p>マウント時にバリアを無効にします。</p>

<pre><code>sudo mount /dev/md127 /mnt -o barrier=0
</code></pre>

<p>では、Premium Storage(P30)をMDで2つ束ねたストライプにfioを実行してみましょう。</p>

<ul>
<li>100% Random Read</li>
<li>キャッシュを無効にするため、Premium StorageのキャッシュはNone、fio側もdirect=1</li>
<li>ブロックサイズは小さめの値が欲しかったので、1K</li>
</ul>

<p>結果。</p>

<pre><code>randread: (g=0): rw=randread, bs=1K-1K/1K-1K/1K-1K, ioengine=libaio, iodepth=32
fio-2.1.3
Starting 1 process

randread: (groupid=0, jobs=1): err= 0: pid=9193: Tue Jan 26 05:48:09 2016
  read : io=102400KB, bw=9912.9KB/s, iops=9912, runt= 10330msec
[snip]
</code></pre>

<p>2本束ねて9,912IOPS。1本あたり5,000IOPS。ほぼ期待値。</p>

                    </div>
                </section>
                
            </div>
            

            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="http://torumakabe.github.io//js/all.min.js"></script>
        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
