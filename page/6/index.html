<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>re-imagine &middot; re-imagine</title>

    <meta name="description" content="my life is the sum of my imagination">

    <meta name="generator" content="Hugo 0.17" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="tmak_tw" />
    <meta name="twitter:title" content="re-imagine &middot; re-imagine">
    <meta name="twitter:description" content="my life is the sum of my imagination">

    <meta property="og:type" content="article">
    <meta property="og:title" content="re-imagine &middot; re-imagine">
    <meta property="og:description" content="my life is the sum of my imagination">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="http://torumakabe.github.io//css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="re-imagine" href="http://torumakabe.github.io//index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="http://torumakabe.github.io/">re-imagine</a></h1>
            <h2 class="brand-tagline"> my life is the sum of my imagination </h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/tmak_tw"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/ToruMakabe "><i class="fa fa-github-alt"></i> github</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="http://torumakabe.github.io//index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">11 Feb 2016, 12:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/azureblobupload_perf/" class="post-title">Azure Blob Upload ツール別ベンチマーク</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="同じ目的を達成できるツールがたくさん">同じ目的を達成できるツールがたくさん</h2>

<p>やりたいことがあり、それを達成する手段がたくさん。どう選ぼう。じゃあ特徴を知りましょう。という話です。</p>

<p>端末からAzureへファイルをアップロードする手段は多くあります。CLIツール、GUIツール、SDKで自作する、etc。</p>

<p>そして、端末と、そのおかれている環境も多様です。Windows、Mac。有線、無線。</p>

<p>で、大事なのは平行度。ブロックBlobはブロックを平行に転送する方式がとれるため、ツールが平行転送をサポートしているか? どのくらい効くのか? は重要な評価ポイントです。</p>

<p>なので、どのツールがおすすめ?と聞かれても、条件抜きでズバっとは答えにくい。そしてこの質問は頻出。なのでこんな記事を書いています。</p>

<h2 id="環境と測定方式">環境と測定方式</h2>

<p>おそらくファイルを送る、という用途でもっとも重視すべき特徴は転送時間でしょう。ではツール、環境別に転送時間を測定してみます。</p>

<p>環境は以下の通り。</p>

<ul>
<li>Windows端末

<ul>
<li>Surface Pro 4 Core i7/16GB Memory/802.11ac</li>
<li>1Gbps Ethernet (USB経由)</li>
<li>Windows 10 (1511)</li>
</ul></li>
<li>Mac端末

<ul>
<li>Macbook 12inch Core M/8GB Memory/802.11ac</li>
<li>USB-C&hellip; 有線テストは省きます</li>
<li>El Capitan</li>
</ul></li>
<li>Wi-Fiアクセスポイント/端末間帯域

<ul>
<li>100~200Mbpsでつながっています</li>
</ul></li>
<li>Azureデータセンタまでの接続

<ul>
<li>日本マイクロソフトの品川オフィスから、首都圏にあるAzure Japan Eastリージョンに接続</li>
<li>よってWAN側の遅延、帯域ともに条件がいい</li>
</ul></li>
<li>対象ツール

<ul>
<li><a href="https://azure.microsoft.com/ja-jp/documentation/articles/storage-use-azcopy/">AzCopy v5.0.0.27</a> (Windowsのみ)</li>
<li><a href="https://azure.microsoft.com/ja-jp/documentation/articles/xplat-cli-install/">Azure CLI v0.9.15</a></li>
<li><a href="http://storageexplorer.com/">Azure Storage Explorer - Cross Platform GUI v0.7</a></li>
</ul></li>
<li>転送ファイル

<ul>
<li>Ubuntu 15.10 ISOイメージ (647MBytes)</li>
</ul></li>
</ul>

<p>そして測定方式。</p>

<p>AzCopyはPowerShellのMeasure-Commandにて実行時間をとります。NCが平行度指定です。デフォルトの平行度はCPUコア数の8倍です。わしのSurface、OSから4コア見えていますので、32。</p>

<pre><code>Measure-Command {AzCopy /Source:C:\Users\myaccount\work /Dest:https://myaccount.blob.core.windows.net/mycontainer /DestKey:mykey /Pattern:ubuntu-15.10-server-amd64.iso /Y /NC:count}
</code></pre>

<p>Azure CLIも同様にMeasure-Commandで。&ndash;concurrenttaskcountで平行度を指定できますが、<a href="https://github.com/Azure/azure-xplat-cli/blob/dev/lib/util/storage.util._js">ソース</a>を確認したところ、平行度のデフォルトは5です。&rdquo;StorageUtil.threadsInOperation = 5;&ldquo;ですね。</p>

<pre><code>Measure-Command {azure storage blob upload ./ubuntu-15.10-server-amd64.iso -a myaccount -k mykey mycontainer ubuntu1510 --concurrenttaskcount count}
</code></pre>

<p>残念ながらMacむけAzCopyはありませんので、Azure CLIのみ実行します。timeコマンドで時間をとります。</p>

<pre><code>time azure storage blob upload ./ubuntu-15.10-server-amd64.iso -a myaccount -k mykey mycontainer ubuntu1510 --concurrenttaskcount count
</code></pre>

<p>Azure Storage Explorer Cross Platform GUIは、目視+iPhoneのストップウォッチで。</p>

<h2 id="結果">結果</h2>

<p>平行度上げても伸びないな、というタイミングまで上げます。</p>

<table>
<thead>
<tr>
<th align="right">　実行No　</th>
<th align="center">　クライアントOS　</th>
<th align="center">　ネットワーク接続　</th>
<th align="center">　クライアント　</th>
<th align="right">　並行数　</th>
<th align="right">　転送時間(秒)　</th>
</tr>
</thead>

<tbody>
<tr>
<td align="right">1</td>
<td align="center">Windows 10</td>
<td align="center">1Gbps Ethernet</td>
<td align="center">AzCopy</td>
<td align="right">(default:32)</td>
<td align="right">9.62</td>
</tr>

<tr>
<td align="right">2</td>
<td align="center">Windows 10</td>
<td align="center">1Gbps Ethernet</td>
<td align="center">AzCopy</td>
<td align="right">5</td>
<td align="right">12.28</td>
</tr>

<tr>
<td align="right">3</td>
<td align="center">Windows 10</td>
<td align="center">1Gbps Ethernet</td>
<td align="center">AzCopy</td>
<td align="right">10</td>
<td align="right">10.83</td>
</tr>

<tr>
<td align="right">4</td>
<td align="center">Windows 10</td>
<td align="center">1Gbps Ethernet</td>
<td align="center">AzCopy</td>
<td align="right">20</td>
<td align="right">10.43</td>
</tr>

<tr>
<td align="right">5</td>
<td align="center">Windows 10</td>
<td align="center">1Gbps Ethernet</td>
<td align="center">Azure CLI</td>
<td align="right">(default:5)</td>
<td align="right">49.92</td>
</tr>

<tr>
<td align="right">6</td>
<td align="center">Windows 10</td>
<td align="center">1Gbps Ethernet</td>
<td align="center">Azure CLI</td>
<td align="right">10</td>
<td align="right">29.47</td>
</tr>

<tr>
<td align="right">7</td>
<td align="center">Windows 10</td>
<td align="center">1Gbps Ethernet</td>
<td align="center">Azure CLI</td>
<td align="right">20</td>
<td align="right">21.05</td>
</tr>

<tr>
<td align="right">8</td>
<td align="center">Windows 10</td>
<td align="center">1Gbps Ethernet</td>
<td align="center">Azure CLI</td>
<td align="right">40</td>
<td align="right">20.12</td>
</tr>

<tr>
<td align="right">9</td>
<td align="center">Windows 10</td>
<td align="center">1Gbps Ethernet</td>
<td align="center">Storage Explorer</td>
<td align="right">N/A</td>
<td align="right">50.10</td>
</tr>

<tr>
<td align="right">10</td>
<td align="center">Windows 10</td>
<td align="center">802.11ac</td>
<td align="center">AzCopy</td>
<td align="right">(default:32)</td>
<td align="right">74.87</td>
</tr>

<tr>
<td align="right">11</td>
<td align="center">Windows 10</td>
<td align="center">802.11ac</td>
<td align="center">AzCopy</td>
<td align="right">5</td>
<td align="right">53.32</td>
</tr>

<tr>
<td align="right">12</td>
<td align="center">Windows 10</td>
<td align="center">802.11ac</td>
<td align="center">AzCopy</td>
<td align="right">10</td>
<td align="right">58.85</td>
</tr>

<tr>
<td align="right">13</td>
<td align="center">Windows 10</td>
<td align="center">802.11ac</td>
<td align="center">Azure CLI</td>
<td align="right">(default:5)</td>
<td align="right">57.23</td>
</tr>

<tr>
<td align="right">14</td>
<td align="center">Windows 10</td>
<td align="center">802.11ac</td>
<td align="center">Azure CLI</td>
<td align="right">10</td>
<td align="right">50.71</td>
</tr>

<tr>
<td align="right">15</td>
<td align="center">Windows 10</td>
<td align="center">802.11ac</td>
<td align="center">Azure CLI</td>
<td align="right">20</td>
<td align="right">54.37</td>
</tr>

<tr>
<td align="right">16</td>
<td align="center">Windows 10</td>
<td align="center">802.11ac</td>
<td align="center">Storage Explorer</td>
<td align="right">N/A</td>
<td align="right">54.63</td>
</tr>

<tr>
<td align="right">17</td>
<td align="center">Mac OS X</td>
<td align="center">802.11ac</td>
<td align="center">Azure CLI</td>
<td align="right">(default:5)</td>
<td align="right">40.86</td>
</tr>

<tr>
<td align="right">18</td>
<td align="center">Mac OS X</td>
<td align="center">802.11ac</td>
<td align="center">Azure CLI</td>
<td align="right">10</td>
<td align="right">33.97</td>
</tr>

<tr>
<td align="right">19</td>
<td align="center">Mac OS X</td>
<td align="center">802.11ac</td>
<td align="center">Azure CLI</td>
<td align="right">20</td>
<td align="right">58.57</td>
</tr>

<tr>
<td align="right">20</td>
<td align="center">Mac OS X</td>
<td align="center">802.11ac</td>
<td align="center">Storage Explorer</td>
<td align="right">N/A</td>
<td align="right">58.20</td>
</tr>
</tbody>
</table>

<h2 id="考察">考察</h2>

<ul>
<li>有線AzCopy早い。単純計算で67MByte/s出ています。それぞれの計測点の解釈の違いでBlobサービス制限の60MBytes/sを超えてしまっていますがw。データセンタまでのボトルネックがなければ、ポテンシャルを引き出せることがわかります。</li>
<li>平行度は大きく性能に影響します。

<ul>
<li>平行度が高すぎてもだめ

<ul>
<li>無線AzCopyのデフォルト(平行度32)が平行度10、20より時間がかかっていることからわかる</li>
</ul></li>
<li>デフォルトで遅いからといってあきらめず、平行度変えて試してみましょう</li>
<li>SDK使って自分で作る時も同じ。平行度パラメータを意識してください

<ul>
<li>.NET: BlobRequestOptions</li>
<li>Java/Android: BlobRequestOptions.setConcurrentRequestCount()</li>
<li>Node.js: parallelOperationThreadCount</li>
<li>C++: blob_request_options::set_parallelism_factor</li>
</ul></li>
</ul></li>
<li>Azure CLIよりAzCopyが早い。

<ul>
<li>.NETで最適化できているから合点</li>
<li>Node.jsベースでマルチOS対応のAzure CLIは比べられると分が悪い</li>
<li>でも、802.11acでも無線がボトルネックになっているので、いまどきのWi-Fi環境では似たような性能になる</li>
<li>No.18の結果は無線状態がよかったと想定</li>
</ul></li>
<li>Azure Storage Explorer Cross Platform GUIは、現時点で平行度変えられないので性能面では不利。でも直観的なので、使い分け。</li>
</ul>

<p>WAN条件がいいベンチマークでなので、ぜひみなさんの条件でも試してみてください。遅延の大きなリージョンや途中に帯域ボトルネックがある条件でやると、最適な平行度が変わってくるはずです。</p>

<p>でも一番言いたかったのは、Macbookの有線アダプタ欲しいということです。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">07 Feb 2016, 17:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/fileshare_linuxonazure/" class="post-title">Linux on Azureでファイル共有する方法</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="ファイル共有-あまりおすすめしないです">ファイル共有、あまりおすすめしないです</h2>

<p>いきなりタイトルを否定しました。ロック。</p>

<p>さて、これからクラウド、というお客様に、よく聞かれる質問があります。それは「NFSとかの、ファイル共有使える?」です。頻出です。クラウド頻出質問選手権では、西東京予選で毎年ベスト8入りするレベルの強豪校です。</p>

<p>ですが<strong>個人的には</strong>あまりおすすめしません。クラウドはなるべく共有部分を減らして、スケーラブルに、かつ障害の影響範囲を局所化するべき、と考えるからです。特にストレージはボトルネックや広範囲な障害の要因になりやすい。障害事例が物語ってます。その代わりにオブジェクトストレージなど、クラウド向きの機能がおすすめです。</p>

<p>でも、否定はしません。アプリの作りを変えられないケースもあるかと思います。</p>

<p>そこで、もしAzureでファイル共有が必要であれば、<a href="https://azure.microsoft.com/ja-jp/documentation/articles/storage-introduction/">Azure File Storage</a>を検討してみてください。Azureのマネージドサービスなので、わざわざ自分でサーバたてて運用する必要がありません。楽。</p>

<p>対応プロトコルは、SMB2.1 or 3.0。LinuxからはNFSじゃなくSMBでつついてください。</p>

<p>使い方は公式ドキュメントを。</p>

<p><a href="https://azure.microsoft.com/ja-jp/documentation/articles/storage-azure-cli/#create-and-manage-file-shares">&ldquo;Azure Storage での Azure CLI の使用&rdquo;</a></p>

<p><a href="https://azure.microsoft.com/ja-jp/documentation/articles/storage-how-to-use-files-linux/">&ldquo;Linux で Azure File Storage を使用する方法&rdquo;</a></p>

<p>もうちょっと情報欲しいですね。補足のためにわたしも流します。</p>

<h2 id="azure-cliでストレージアカウントを作成し-ファイル共有を設定">Azure CLIでストレージアカウントを作成し、ファイル共有を設定</h2>

<p>ストレージアカウントを作ります。fspocは事前に作っておいたリソースグループです。</p>

<pre><code>local$ azure storage account create tomakabefspoc -l &quot;Japan East&quot; --type LRS -g fspoc
</code></pre>

<p>ストレージアカウントの接続情報を確認します。必要なのはdata: connectionstring:の行にあるAccountKey=以降の文字列です。このキーを使ってshareの作成、VMからのマウントを行うので、控えておいてください。</p>

<pre><code>local$ azure storage account connectionstring show tomakabefspoc -g fspoc
info:    Executing command storage account connectionstring show
+ Getting storage account keys
data:    connectionstring: DefaultEndpointsProtocol=https;AccountName=tomakabefspoc;AccountKey=qwertyuiopasdfghjklzxcvbnm==
info:    storage account connectionstring show command OK
</code></pre>

<p>shareを作成します。share名はfspocshareとしました。</p>

<pre><code>local$ azure storage share create -a tomakabefspoc -k qwertyuiopasdfghjklzxcvbnm== fspocshare
</code></pre>

<p>エンドポイントを確認しておきましょう。VMからのマウントの際に必要です。</p>

<pre><code>local$ azure storage account show tomakabefspoc -g fspoc
[snip]
data:    Primary Endpoints: file https://tomakabefspoc.file.core.windows.net/
</code></pre>

<h2 id="linux-2vmで共有">Linux * 2VMで共有</h2>

<p>Ubuntuでやりますよ。SMBクライアントとしてcifs-utilsパッケージをインストールします。<a href="https://azure.microsoft.com/ja-jp/marketplace/partners/canonical/ubuntuserver1404lts/">Marketplace提供の14.04 LTS</a>であれば、すでに入ってるはずです。</p>

<pre><code>fspocvm01:~$ sudo apt-get install cifs-utils
</code></pre>

<p>マウントポイントを作り、マウントします。接続先の指定はエンドポイント+share名で。usernameはストレージアカウント名。パスワードはストレージアカウントのキーです。
パーミッションは要件に合わせてください。</p>

<pre><code>fspocvm01:~$ sudo mkdir -p /mnt/fspoc
fspocvm01:~$ sudo mount -t cifs //tomakabefspoc.file.core.windows.net/fspocshare /mnt/fspoc -o vers=3.0,username=tomakabefspoc,password=qwertyuiopasdfghjklzxcvbnm==,dir_mode=0777,file_mode=0777
</code></pre>

<p>マウント完了。確認用のファイルを作っておきます。</p>

<pre><code>fspocvm01:~$ echo &quot;test&quot; &gt; /mnt/fspoc/test.txt
fspocvm01:~$ cat /mnt/fspoc/test.txt
test
</code></pre>

<p>2台目のVMでも同様のマウント作業を。</p>

<pre><code>fspocvm02:~$ sudo apt-get install cifs-utils
fspocvm02:~$ sudo mkdir -p /mnt/fspoc
fspocvm02:~$ sudo mount -t cifs //tomakabefspoc.file.core.windows.net/fspocshare /mnt/fspoc -o vers=3.0,username=tomakabefspoc,password=qwertyuiopasdfghjklzxcvbnm==,dir_mode=0777,file_mode=0777
</code></pre>

<p>1台目で作ったファイルが見えますね。</p>

<pre><code>fspocvm02:~$ ls /mnt/fspoc
test.txt
fspocvm02:~$ cat /mnt/fspoc/test.txt
test
</code></pre>

<p>ファイルをいじりましょう。</p>

<pre><code>fspocvm02:~$ echo &quot;onemoretest&quot; &gt;&gt; /mnt/fspoc/test.txt
fspocvm02:~$ cat /mnt/fspoc/test.txt
test
onemoretest
</code></pre>

<p>1台目から確認。</p>

<pre><code>fspocvm01:~$ cat /mnt/fspoc/test.txt
test
onemoretest
</code></pre>

<h2 id="ご利用は計画的に">ご利用は計画的に</h2>

<p>2016年2月時点で、Azure File Storageには最大容量:5TB/share、1TB/file、ストレージアカウントあたりの帯域:60MBytes/sという制約があります。これを超えるガチ共有案件では、<a href="https://azure.microsoft.com/en-us/marketplace/partners/intel/lustre-cloud-edition-evaleval-lustre-2-7/">Lustre</a>など別の共有方法を検討してください。</p>

<p>なおファイルサーバ用途であれば、Azure File Storageではなく、OneDriveなどオンラインストレージSaaSに移行した方が幸せになれると思います。企業向けが使いやすくなってきましたし。運用から解放されるだけじゃなく、便利ですよ。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">27 Jan 2016, 00:19</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/striping_linuxonazure/" class="post-title">Linux on AzureでDisk IO性能を確保する方法</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="俺の鉄板-ができるまで">&ldquo;俺の鉄板&rdquo;ができるまで</h2>

<p>前半はポエムです。おそらくこのエントリにたどり着く人の期待はLinux on AzureのDisk IO性能についてと思いますが、それは後半に書きます。</p>

<p>クラウド、Azureに関わらず、技術や製品の組み合わせは頭の痛い問題です。「これとこれ、組み合わせて動くの？サポートされるの？性能出るの？」という、あれです。技術や製品はどんどん進化しますので、同じ組み合わせが使えることは珍しくなってきています。</p>

<p>ちなみにお客様のシステムを設計する機会が多いわたしは、こんな流れで検討します。</p>

<ol>
<li>構成要素全体を俯瞰したうえで、調査が必要な技術や製品、ポイントを整理する

<ul>
<li>やみくもに調べものしないように</li>
<li>経験あるアーキテクトは実績ある組み合わせや落とし穴を多くストックしているので、ここが早い</li>
</ul></li>
<li>ベンダの公式資料を確認する

<ul>
<li>「この使い方を推奨/サポートしています」と明記されていれば安心</li>
<li>でも星の数ほどある技術や製品との組み合わせがすべて網羅されているわけではない</li>
<li>不明確なら早めに問い合わせる</li>
</ul></li>
<li>ベンダが運営しているコミュニティ上の情報を確認する

<ul>
<li>ベンダの正式見解ではない場合もあるが、その製品を担当する社員が書いている情報には信ぴょう性がある</li>
</ul></li>
<li>コミュニティや有識者の情報を確認する

<ul>
<li>OSSでは特に</li>
<li>専門性を感じるサイト、人はリストしておく</li>
</ul></li>
<li>動かす

<ul>
<li>やっぱり動かしてみないと</li>
</ul></li>
<li>提案する

<ul>
<li>リスクがあれば明示します</li>
</ul></li>
<li>問題なければ実績になる、問題があればリカバリする

<ul>
<li>提案しっぱなしにせずフォローすることで、自信とパターンが増える</li>
<li>次の案件で活きる
<br /></li>
</ul></li>
</ol>

<p>いまのわたしの課題は4、5です。特にOSS案件。AzureはOSSとの組み合わせを推進していて、ここ半年でぐっと情報増えたのですが、まだ物足りません。断片的な情報を集め、仮説を立て、動かす機会が多い。なので、5を増やして、4の提供者側にならんとなぁ、と。</p>

<h2 id="linux-on-azureでdisk-io性能を確保する方法">Linux on AzureでDisk IO性能を確保する方法</h2>

<p>さて今回の主題です。</p>

<p>結論: Linux on AzureでDisk IOを最大化するには、MDによるストライピングがおすすめ。いくつかパラメータを意識する。</p>

<p>Linux on AzureでDisk IO性能を必要とする案件がありました。検討したアイデアは、SSDを採用したPremium Storageを複数束ねてのストライピングです。Premium Storageはディスクあたり5,000IOPSを期待できます。でも、それで足りない恐れがありました。なので複数並べて平行アクセスし、性能を稼ぐ作戦です。</p>

<p>サーバ側でのソフトウェアストライピングは古くからあるテクニックで、ハードの能力でブン殴れそうなハイエンドUnixサーバとハイエンドディスクアレイを組み合わせた案件でも、匠の技として使われています。キャッシュやアレイコントローラ頼りではなく、明示的にアクセスを分散することで性能を確保することができます。</p>

<p>Linuxで使える代表的なストライプ実装は、LVMとMD。</p>

<p>ではAzure上でどちらがを選択すべきでしょう。この案件では性能が優先事項です。わたしはその時点で判断材料を持っていませんでした。要調査。この絞り込みまでが前半ポエムの1です。</p>

<p>前半ポエムの2、3はググ、もといBing力が試される段階です。わたしは以下の情報にたどり着きました。</p>

<p><a href="https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-linux-configure-raid/">&ldquo;Configure Software RAID on Linux&rdquo;</a></p>

<p><a href="https://azure.microsoft.com/ja-jp/documentation/articles/storage-premium-storage-preview-portal/">&ldquo;Premium Storage: Azure 仮想マシン ワークロード向けの高パフォーマンス ストレージ&rdquo;</a></p>

<p><a href="http://blogs.msdn.com/b/igorpag/archive/2014/10/23/azure-storage-secrets-and-linux-i-o-optimizations.aspx">&ldquo;Azure Storage secrets and Linux I/O optimizations&rdquo;</a></p>

<p>得られた情報の中で大事なのは、</p>

<ul>
<li>公式ドキュメントで

<ul>
<li>LVMではなくMDを使った構成例が紹介されている</li>
</ul></li>
<li>マイクロソフトがホストするブログ(MSDN)で、エキスパートが

<ul>
<li>LVMと比較したうえで、MDをすすめている</li>
<li>MDのChunkサイズについて推奨値を紹介している</li>
<li>そのほか、ファイルシステムやスケジューラに関する有益な情報あり</li>
</ul></li>
</ul>

<p>なるほど。わたしのこの時点での方針はこうです。</p>

<ul>
<li>LVMを使う必然性はないため、MDに絞る

<ul>
<li>LVMのほうが機能豊富だが、目的はストライピングだけであるため、シンプルなほうを</li>
<li>物理障害対策はAzureに任せる (3コピー)</li>
</ul></li>
<li>MDのChunkをデフォルトの512KBから64KBに変更する (ここは結果によって調整)</li>
<li>Premium StorageのキャッシュはReadOnly or Noneにする予定であるため、ファイルシステムのバリアを無効にする</li>
</ul>

<p>上記シナリオで、ディスク当たり5,000IOPS、ストライプ数に比例した性能が実際出れば提案価値あり、ということになります。
ですが、ズバリな実績値が見つからない。ダラダラ探すのは時間の無駄。これは自分でやるしかない。</p>

<p>構成手順は前述のリンク先にありますが、ポイントを抜き出します。OS=Ubuntu、ファイルシステム=ext4の場合です。</p>

<p>MDでストライプを作る際、チャンクを64KBに変更します。</p>

<pre><code>sudo mdadm --create /dev/md127 --level 0 --raid-devices 2  /dev/sdc1 /dev/sdd1 -c 64k
</code></pre>

<p>マウント時にバリアを無効にします。</p>

<pre><code>sudo mount /dev/md127 /mnt -o barrier=0
</code></pre>

<p>では、Premium Storage(P30)をMDで2つ束ねたストライプにfioを実行してみましょう。</p>

<ul>
<li>100% Random Read</li>
<li>キャッシュ効果のないデータをとるため、Premium StorageのキャッシュはNone、fio側もdirect=1</li>
<li>ブロックサイズは小さめの値が欲しかったので、1K</li>
</ul>

<p>結果。</p>

<pre><code>randread: (g=0): rw=randread, bs=1K-1K/1K-1K/1K-1K, ioengine=libaio, iodepth=32
fio-2.1.3
Starting 1 process

randread: (groupid=0, jobs=1): err= 0: pid=9193: Tue Jan 26 05:48:09 2016
  read : io=102400KB, bw=9912.9KB/s, iops=9912, runt= 10330msec
[snip]
</code></pre>

<p>2本束ねて9,912IOPS。1本あたりほぼ5,000IOPS。ほぼ期待値。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">24 Jan 2016, 00:19</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/doubt_lackofperf_oncloud/" class="post-title">クラウドは本当に性能不足なのか</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p><strong>このエントリは2016/1/24に書きました。使えるリソースはどんどん増えていくので、適宜その時点で情報をとってください。</strong></p>

<h2 id="具体的な数値で-正しい理解を">具体的な数値で、正しい理解を</h2>

<p><a href="http://itpro.nikkeibp.co.jp/atcl/watcher/14/334361/011800463/">&ldquo;クラウドは性能不足、企業システムが重すぎる&rdquo;</a>という記事が身の回りで話題になりました。公開から4日たっても「いま読まれている記事」の上位にあり、注目されているようです。</p>

<p>記事で訴えたかったことは、クラウドを過信しないように、そして、クラウドはクラウドらしい使い方をしよう、ということでしょう。ユーザの声は貴重ですし、同意できるところも多い。でも、「企業システム」とひとくくりにしてしまったこと。タイトルのバイアスが強いこと。そして、具体的な根拠に欠けることから、誤解を招いている印象です。</p>

<p>どんな技術、製品、サービスにも限界や制約はあります。具体的な数値や仕様で語らないと、そこから都市伝説が生まれます。</p>

<p>いい機会なので、わたしの主戦場であるAzureを例に、クラウドでどのくらいの性能を期待できるか、まとめてみようと思います。</p>

<h2 id="シングルvmでどれだけ">シングルVMでどれだけ</h2>

<p>話題となった記事でも触れられているように、クラウドはその生まれから、分散、スケールアウトな作りのアプリに向いています。ですが世の中には「そうできない」「そうするのが妥当ではない」システムもあります。記事ではそれを「企業システム」とくくっているようです。</p>

<p>わたしは原理主義者ではないので「クラウドに載せたかったら、そのシステムを作り直せ」とは思いません。作りを大きく変えなくても載せられる、それでクラウドの特徴を活かして幸せになれるのであれば、それでいいです。もちろん最適化するにこしたことはありませんが。</p>

<p>となると、クラウド活用の検討を進めるか、あきらめるか、判断材料のひとつは「スケールアウトできなくても、性能足りるか?」です。</p>

<p>この場合、1サーバ、VMあたりの性能上限が制約です。なので、AzureのシングルVM性能が鍵になります。</p>

<p>では、Azureの仮想マシンの提供リソースを確認しましょう。</p>

<p><a href="https://azure.microsoft.com/ja-jp/documentation/articles/virtual-machines-size-specs/">&ldquo;仮想マシンのサイズ&rdquo;</a></p>

<p>ざっくりA、D、Gシリーズに分けられます。Aは初期からあるタイプ。ＤはSSDを採用した現行の主力。Gは昨年後半からUSリージョンで導入がはじまった、大物です。ガンダムだと後半、宇宙に出てから登場するモビルアーマー的な存在。現在、GシリーズがもっともVMあたり多くのリソースを提供できます。</p>

<p>企業システムではOLTPやIOバウンドなバッチ処理が多いと仮定します。では、Gシリーズ最大サイズ、Standard_GS5の主な仕様から、OLTPやバッチ処理性能の支配要素となるCPU、メモリ、IOPSを見てみましょう。</p>

<ul>
<li>Standard_GS5の主な仕様

<ul>
<li>32仮想CPUコア</li>
<li>448GBメモリ</li>
<li>80,000IOPS</li>
</ul></li>
</ul>

<p>メモリはクラウドだからといって特記事項はありません。クラウドの特徴が出るCPUとIOPSについて深掘りしていきます。</p>

<p>なお、<strong>現時点で</strong>まだ日本リージョンにはGシリーズが投入されていません。必要に応じ、公開スペックと後述のACUなどを使ってA、Dシリーズと相対評価してください。</p>

<h2 id="32仮想cpuコアの規模感">32仮想CPUコアの規模感</h2>

<p>クラウドのCPU性能表記は、なかなか悩ましいです。仮想化していますし、CPUは世代交代していきます。ちなみにAzureでは、ACU(Azure Compute Unit)という単位を使っています。</p>

<p><a href="https://azure.microsoft.com/ja-jp/documentation/articles/virtual-machines-size-specs/#-3">&ldquo;パフォーマンスに関する考慮事項&rdquo;</a></p>

<p>ACUはAzure内で相対評価をする場合にはいいのですが、「じゃあAzureの外からシステムもってきたとき、実際どのくらいさばけるのよ。いま持ってる/買えるサーバ製品でいうと、どのくらいよ」という問いには向きません。</p>

<p>クラウドや仮想化に関わらず、アプリの作りと処理するデータ、ハードの組み合わせで性能は変わります。動かしてみるのが一番です。せっかくイニシャルコストのかからないクラウドです。試しましょう。でもその前に、試す価値があるか判断しなければいけない。なにかしらの参考値が欲しい。予算と組織で動いてますから。わかります。</p>

<p>では例をあげましょう。<strong>俺のベンチマーク</strong>を出したいところですが、「それじゃない」と突っ込まれそうです。ここはぐっと我慢して、企業でよく使われているERP、SAPのSAP SDベンチマークにしましょう。</p>

<p><a href="http://global.sap.com/campaigns/benchmark/appbm_cloud.epx">&ldquo;SAP Standard Application Benchmarks in Cloud Environments&rdquo;</a></p>

<p><a href="http://global.sap.com/campaigns/benchmark/index.epx">&ldquo;SAP Standard Application Benchmarks&rdquo;</a></p>

<p>SAPSという値が出てきます。販売管理アプリケーションがその基盤上でどれだけ仕事ができるかという指標です。</p>

<p>比較のため、3年ほど前の2ソケットマシン、現行2ソケットマシン、現行4ソケットマシンを選びました。単体サーバ性能をみるため、APとDBを1台のサーバにまとめた、2-Tierの値をとります。</p>

<table>
<thead>
<tr>
<th align="left"></th>
<th align="left"><a href="http://download.sap.com/download.epd?context=40E2D9D5E00EEF7C91D3C5AFFF9A4689C82EA97027CDF4A42858AD1610A3F732">DELL R720</a></th>
<th align="left"><a href="http://global.sap.com/campaigns/benchmark/assets/Cert15038.pdf">Azure VM GS5</a></th>
<th align="left"><a href="http://download.sap.com/download.epd?context=40E2D9D5E00EEF7CFDB9CAEA540B6F601993E4359AB45BEF7ED0949D1BFF155D">NEC R120f-2M</a></th>
<th align="left"><a href="http://download.sap.com/download.epd?context=40E2D9D5E00EEF7C14B03FD143D20C6C90E8F6DEAA4E15F8090BA77A6249E1D0">FUJITSU RX4770 M2</a></th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">Date</td>
<td align="left"><sup>2012</sup>&frasl;<sub>4</sub></td>
<td align="left"><sup>2015</sup>&frasl;<sub>9</sub></td>
<td align="left"><sup>2015</sup>&frasl;<sub>7</sub></td>
<td align="left"><sup>2015</sup>&frasl;<sub>7</sub></td>
</tr>

<tr>
<td align="left">CPU Type</td>
<td align="left">Intel Xeon Processor E5-2690</td>
<td align="left">Intel Xeon Processor E5-2698B v3</td>
<td align="left">Intel Xeon Processor E5-2699 v3</td>
<td align="left">Intel Xeon Processor E7-8890 v3</td>
</tr>

<tr>
<td align="left">CPU Sockets</td>
<td align="left">2</td>
<td align="left">2</td>
<td align="left">2</td>
<td align="left">4</td>
</tr>

<tr>
<td align="left">CPU Cores</td>
<td align="left">16</td>
<td align="left">32 (Virtual)</td>
<td align="left">36</td>
<td align="left">72</td>
</tr>

<tr>
<td align="left">SD Benchmark Users</td>
<td align="left">6,500</td>
<td align="left">7,600</td>
<td align="left">14,440</td>
<td align="left">29,750</td>
</tr>

<tr>
<td align="left">SAPS</td>
<td align="left">35,970</td>
<td align="left">41,670</td>
<td align="left">79,880</td>
<td align="left">162,500</td>
</tr>
</tbody>
</table>

<p>3年前の2ソケットマシンより性能はいい。現行2ソケットマシンの半分程度が期待値でしょうか。ざっくりE5-2699 v3の物理18コアくらい。4ソケットは無理め。</p>

<p>なお補足ですが、もちろんSAPはAPサーバをスケールアウトする構成もとれます。その性能は<a href="http://global.sap.com/campaigns/benchmark/appbm_cloud.epx">3-Tierベンチマーク</a>で確認できます。<a href="http://blogs.msdn.com/b/saponsqlserver/archive/2015/10/05/world-record-sap-sales-and-distribution-standard-application-benchmark-for-sap-cloud-deployments-released-using-azure-iaas-vms.aspx">Azure上で247,880SAPS</a>出たそうです。</p>

<h2 id="80-000iopsの規模感">80,000IOPSの規模感</h2>

<p>IOPS = IO Per Second、秒あたりどれだけIOできるかという指標です。Azure VM GS5では<a href="https://azure.microsoft.com/ja-jp/documentation/articles/storage-premium-storage-preview-portal/">Premium Storage</a>を接続し、VMあたり最大80,000IOPSを提供します。</p>

<p>一般的に企業で使われているディスクアレイに載っているHDDのIOPSは、1本あたりおおよそ200です。IOPSに影響する要素は回転数で、よく回る15,000rpm FC/SAS HDDでだいたいこのくらい。</p>

<p>なので80,000 / 200 = 400。よって80,000IOPSを達成しようとすると、HDDを400本並べないといけません。小さくないです。</p>

<p>もちろんディスクアレイにはキャッシュがあるので、キャッシュヒット次第でIOPSは変わります。ベンダが胸を張って公開している値も、キャッシュに当てまくった数字であることが多いです。ですが誠実な技術者は「水物」なキャッシュヒットを前提にサイジングしません。アプリがアレイを占有できて、扱うデータの量や中身に変化がない場合は別ですが、それはまれでしょう。ヒットしない最悪の場合を考慮するはずです。</p>

<p>なお、数十万IOPSをこえるディスクアレイがあるのは事実です。でも「桁が違う。クラウドしょぼい」と思わないでください。ディスクアレイ全体の性能と、VMあたりどのくらい提供するかは、別の問題です。ひとつのVMがディスクアレイを占有するのでない限り、VMあたりのIOコントロールは必要です。そうでないと、暴れん坊VMの割を食うVMがでてきます。見えていないだけで、クラウドのバックエンドにはスケーラブルなストレージが鎮座しています。</p>

<h2 id="結論">結論</h2>

<ul>
<li>Intel x86 2ソケットモデルサーバで動いているようなシステムの移行であれば検討価値あり</li>
<li>メモリが448GB以上必要であれば難しい</li>
<li>サーバあたり80,000IOPS以上必要であれば難しい、でも本当にサーバあたりそれだけ必要か精査すべき</li>
</ul>

<p>ちょっと前までオンプレ案件も担当していましたが、ここ数年は2ソケットサーバ案件中心、ときどき、4ソケット以上で興奮。という感覚です。みなさんはいかがでしょう。データはないのでご参考まで。</p>

<p>なにはともあれ、プロのみなさんは噂に流されず、制約を数値で把握して判断、設計しましょう。Azureではそのほかの制約条件も公開されていますので、ぜひご一読を。上限を緩和できるパラメータも、あります。</p>

<p><a href="https://azure.microsoft.com/ja-jp/documentation/articles/azure-subscription-service-limits/">&ldquo;Azure サブスクリプションとサービスの制限、クォータ、制約&rdquo;</a></p>

                    </div>
                </section>
                
                <h1 class="content-subhead">11 Jan 2016, 00:20</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://torumakabe.github.io/post/azure_infradeployment_selection/" class="post-title">Azureでインフラデプロイツールを選ぶ時に考えていること</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Azure" href="http://torumakabe.github.io//categories/azure">Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="ケースバイケースだけど">ケースバイケースだけど</h2>

<p>Azureを生業にして、3か月たちます。ここまで、もっとも質問や議論が多いのが、デプロイメントの自動化についてです。進化が早いですし、選択肢も豊富。クラウド採用に合わせて自動化に挑戦するケースも増えてますので、自然なことと思います。</p>

<p>特に話題になるのが「どのツールを選べばいいか」。ツールというのは課題を解決する手段なので、まず課題を掘るべきです。ですが、まだ成熟していない領域で変化が激しいですし、ツールひとつで課題を解決できるとも限らない。複数のツールを組み合わせることも多く、依存関係もありそう。となると、考えるきっかけが欲しいのは、ごもっとも。</p>

<p>なので「ケースバイケース。以上」とは、言いにくい。</p>

<p>私見であっても、たたき台となる考え方なりパターンがWebに転がっていれば、参考になるかもしれない。それがこのエントリを書く動機です。わたしは他のプラットフォームからAzureに主戦場を移していますので、新鮮な意見が書けるかも、という背景も、あります。</p>

<h2 id="書く前に前提など">書く前に前提など</h2>

<p>対象はインフラレイヤのデプロイメントに絞ります。そして、インフラ = 物理/仮想ハードウェア(サーバ、ストレージ、ネットワーク) + OS + プラットフォームソフト(アプリじゃないもの、Webサーバ、ユーティリティ、etc）と定義します。</p>

<p>レイヤリングや用語は、 @gosukenator さんの<a href="http://mizzy.org/blog/2013/10/29/1/">&ldquo;インフラ系技術の流れ&rdquo;</a>が参考になるので、合わせて読むと幸せになれるでしょう。このエントリで言うBootstrapping/Configurationレイヤが今回の焦点です。</p>

<p>では、わたしがツールを選ぶ時にどんなことを考えているのか、脳内をダンプしていきましょう。</p>

<h2 id="そもそもツールで自動化すべきかを考える">そもそもツールで自動化すべきかを考える</h2>

<p>いきなり萎えるそもそも論で恐縮ですが、重要です。たとえばあるソフトの試用目的で、同じ構成のサーバのデプロイは今後しなさそう、台数は1台、使うのは自分だけ、なんていう環境のデプロイまで、自動化する必要はないはずです。時短、工数削減、オペレーションミスリスクの軽減、そもそも自動化しないと運用がまわらない、など自動化によって得られる利益がその手間を上回るかを判断します。</p>

<p>なお「知っている/できる」人でないとその価値、利益はわかりません。やらないという判断は、腕があってはじめてできることです。</p>

<h2 id="使い捨てられないかを考える">使い捨てられないかを考える</h2>

<p>次は、ツールによって作った環境がどのように変化するか、変えられるかを検討します。ストレートに言うと、変化のタイミングで捨てられないか？新しいものに置き換えられないか？を考えます。もしこれができるのであれば、方式はとてもシンプルにできます。Immutable Infrastructure、Blue/Green Deploymentなどのやり口が注目されていますが、これらの根っこには「ちまちま変化を加えて複雑化するくらいなら、使い捨て/入れ替えてしまえ」という意識があります。</p>

<p>ですが、とは言ってもそんな大胆にできない事情もあると思います。Blue/Green Deploymentでは、入れ替えのタイミングでBlue、Green分のリソースが必要になりますし、切り替えにともなうリスクもあります。それを許容できない場合、同じインフラに変化を積んでいくことになります。ChefなどConfigurationレイヤで冪等なオペーレーションができるツールが注目されたのは、この変化を維持しやすいからです。</p>

<p>変化を積む場合にやるべきでないのは、中途半端に職人が真心こめて手作業してしまうことです。ツールでやると決めたら、少なくともそのカバー範囲はツールに任せましょう。でないといわゆる「手作業汚れ」「スノーフレークサーバ（雪の結晶のように、全部同じように見えて実はそれぞれ違う）」のダークサイドに堕ちます。</p>

<p>変化を積まないのであれば、インフラデプロイメント用途ではConfigurationレイヤのツールを導入しないという割り切りもできるでしょう。</p>

<h2 id="優先事項や制約条件を洗い出す">優先事項や制約条件を洗い出す</h2>

<p>アーキテクトが真っ白なキャンバスに画を描けることはほぼありません。きっと、先になんらかの優先事項や制約条件があるはずです。そして、ほとんどのシステムにおいて、インフラのデプロイは主役ではありません。ツールに合わせてもらえることはまれでしょう。様々な条件を選定にあたって洗い出す必要があります。</p>

<ul>
<li><em>社内/プロジェクト標準</em></li>
</ul>

<p>　周知されていないだけで、推奨ツールが決まってたりします。あるある。そのツールの良し悪しは置いておいて、社内ノウハウの蓄積など、大きな目的がある場合には従うべきでしょう。</p>

<ul>
<li><em>他レイヤでの優先ツール</em></li>
</ul>

<p>　インフラのデプロイに影響がありそうなツールがアプリ開発側で決まっていたりします。最近華やかなのがDockerです。Docker社が出してるツール群は上から下までカバー範囲も広く、デプロイツールと重複しがちです。組み合わせを検討しなければいけません。また、Apache Mesosもインフラとアプリのグレーゾーンに鎮座します。なかなか悩ましいですが、優先せざるをえません。</p>

<ul>
<li><em>規模</em></li>
</ul>

<p>　いきなり1000台とか10000台規模を扱うユーザは多くないと思いますが、その規模になるとツールの性能限界にぶち当たったりします。念のため、意識はしましょう。ちなみに、1000台をひとつのツールの傘に入れずとも、たとえば10*100台にする設計ができないか、事前に考えておくと打ち手が増えます。</p>

<ul>
<li><em>チーム or ひとり</em></li>
</ul>

<p>　本番環境のデプロイ自動化はチームプレイになるので、ツールの導入はサーバ上になるでしょうし、構成ファイルの共有、バージョンコントロールなど考慮点は多いです。一方で、開発者が開発、検証用途で端末に導入し実行する使い方では、手軽さが求められます。誤解を恐れず例をあげると、前者にはChefが、後者にはAnsibleやTerraformがフィットしやすいです。</p>

<ul>
<li><em>Windows or Linux</em></li>
</ul>

<p>　Azure ARM Templateなど、はじめからマルチOS環境を前提に作られているツールはありますが、ほとんどのツールはその生まれがWindows、Linuxに寄っています。マルチOS対応が進んではいますが、活用にあたって、参考となる情報量には大きな差があります。たとえばマルチOS対応のツールであっても、DSCはWindowsの、ChefやAnsibleはLinuxの情報が圧倒的に多いです。これは意識せざるを得ません。使うOSでの十分な情報があるか確認します。</p>

<h2 id="マネージドサービス-機能を活用する">マネージドサービス、機能を活用する</h2>

<p>マネージドサービス = プラットフォームが提供している機能です。Azureであれば、今回対象としているレイヤではARMがそれにあたります。デプロイツールは有用ですが、その導入や維持運用には本質的価値はありません。プラットフォームに任せられるのであれば、そうしたほうが楽です。</p>

<p>また、Azureのインフラは進化が早いため、それに対応するスピードも、本家ツールのほうが期待できます。</p>

<p>ですが、<a href="http://torumakabe.github.io/post/arm_idempotent/">以前のエントリ</a>で触れたように、本家のツールであっても、すべてのレイヤをカバーできるほど万能ではありません。たとえばARM TemplateはインフラのBootstrappingには向いていますが冪等性が限定的であるため、ソフトウェアパッケージを足す/消す/入れ替えるを頻繁に繰り返す環境のConfiguration用途では、苦しいです。</p>

<p>よってARM Templateは、Immutableな環境で使う、もしくは、ChefなどのConfigurationツールと組み合わせて使うことを念頭に設計をします。</p>

<p>ARM Templateでは、ハード(VM、ストレージ、ネットワーク)の割り当て、OSの導入と設定、各種エージェントの導入が基本。それに加え、Immutableな環境ではプラットフォームソフトを導入してしまっていいでしょう。ARM TemplateにはDSCやシェルを実行するエクステンションが使えるので、活用します。</p>

<p>また、Bootstrapping時点で、Configurationツールを導入できてしまうのであれば、せっかくなので入れてしまいましょう。たとえばChefサーバのインストールは、ここで。</p>

<p>以上、ちょっとまとまりに欠けますが、ざっとわたしが意識していることを、挙げてみました。</p>

<h2 id="汎用的-リファレンスアーキテクチャ">汎用的 リファレンスアーキテクチャ</h2>

<p>具体例があったほうが分かりやすいので、最後に汎用的な組み合わせを紹介します。</p>

<p><a href="https://gallery.technet.microsoft.com/Automating-Deployment-with-84c1549f">&ldquo;Automating Deployment with Azure &amp; Chef&rdquo;</a></p>

<ul>
<li><p>ARM TemplateでBootstrapping</p>

<ul>
<li>VMを4つ作成、1つはLinux、他はWindows</li>
<li>ストレージ、ネットワークの作成</li>
<li>VMのストレージ、ネットワーク設定</li>
<li>OSの導入</li>
<li>ドメインコントローラサーバへのソフト導入、各種設定 (DSC/PowerShell Extension)</li>
<li>他Windowsサーバへのソフト導入、各種設定、ドメイン参加 (PowerShell Extension)</li>
<li>LinuxへChefサーバを導入、各種設定 (Shell Extension)
<br /></li>
</ul></li>

<li><p>ChefでConfiguration</p>

<ul>
<li>各ノードのChef bootstrap(言葉が混同しやすいので注意)</li>
<li>Chef Clientサービスの起動設定</li>
<li>DBサーバのDB領域ディスク作成、フォーマット</li>
<li>DBサーバへSQL Server 2014のインストール</li>
<li>ChefがDBサーバが設定通りになるよう維持し続ける
<br /></li>
</ul></li>
</ul>

<p>どうでしょう、役割分担がイメージできたでしょうか。いいドキュメントがあったので、ChefのLinux/Windows混在例を紹介しましたが、Windowsとの親和性や情報量を重視するなら、ChefをAzure Automation DSCに置き換えて挑戦してもいいでしょう。そのまた逆もありで、ChefならLinux染めな環境で、とこだわってもいいと思います。</p>

<p>書くことが意外に多かったので、また機会があれば、参考例を交えて紹介します。</p>

                    </div>
                </section>
                
            </div>
            
<div class="pagination">
  <nav role="pagination" class="post-list-pagination">
      
      <a href="/page/5/" class="post-list-pagination-item pure-button post-list-pagination-item-prev">
        <i class="fa fa-angle-double-left"></i>&nbsp;Newer
      </a>
      
    <span class="post-list-pagination-item post-list-pagination-item-current">Page 6 of 10</span>
    
      <a href="/page/7/" class="post-list-pagination-item pure-button post-list-pagination-item-next">
        Older&nbsp;<i class="fa fa-angle-double-right"></i>
      </a>
    
  </nav>
</div>


            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="http://torumakabe.github.io//js/all.min.js"></script>
        </div>
    </div>
</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
